<section class="tab details {{tab.cssClass}} perk-details-wrapper" data-group="primary" data-tab="details">

    {{!-- 1. Prerequisites Section --}}
    <div class="perk-prerequisites-section">
        <div class="prereq-add-header">
            <label for="prereq-type-select"><i class="fas fa-plus-circle"></i> {{localize 'VAGABOND.Item.Perk.AddPrerequisiteLabel'}}</label>
            <select id="prereq-type-select" data-action="addPrerequisiteType">
                <option value="">{{localize 'VAGABOND.Item.Perk.SelectPrerequisiteType'}}</option>
                <option value="stat">{{localize 'VAGABOND.Item.Perk.PrereqTypeStat'}}</option>
                <option value="statOrGroup">{{localize 'VAGABOND.Item.Perk.PrereqTypeStatOrGroup'}}</option>
                <option value="trainedSkill">{{localize 'VAGABOND.Item.Perk.PrereqTypeTrainedSkill'}}</option>
                <option value="trainedSkillOrGroup">{{localize 'VAGABOND.Item.Perk.PrereqTypeTrainedSkillOrGroup'}}</option>
                <option value="spell">{{localize 'VAGABOND.Item.Perk.PrereqTypeSpell'}}</option>
                <option value="spellOrGroup">{{localize 'VAGABOND.Item.Perk.PrereqTypeSpellOrGroup'}}</option>
                <option value="resource">{{localize 'VAGABOND.Item.Perk.PrereqTypeResource'}}</option>
                <option value="resourceOrGroup">{{localize 'VAGABOND.Item.Perk.PrereqTypeResourceOrGroup'}}</option>
            </select>
        </div>

        <div class="prereq-sections-wrapper">

            {{!-- Stats (only show if exists) --}}
            {{#if item.system.prerequisites.stats.length}}
            <div class="prereq-group prereq-section-card">
                <div class="group-header">
                    <span><a class="add-btn" data-action="addStatPrerequisite" title="Add stat"><i class="fas fa-plus-circle"></i></a> {{localize 'VAGABOND.Item.Perk.FIELDS.prerequisites.stats.label'}}</span>
                    <div class="header-actions">
                        <a class="clear-btn" data-action="clearAllStats" title="Clear all stats"><i class="fas fa-times-circle"></i></a>
                    </div>
                </div>
                <div class="prereq-list">
                    {{#each item.system.prerequisites.stats as |stat index|}}
                    <div class="prereq-row">
                        <select name="system.prerequisites.stats.{{index}}.stat">
                            <option value="might" {{#if (eq stat.stat 'might')}}selected{{/if}}>{{localize 'VAGABOND.Stat.Might.abbr'}}</option>
                            <option value="dexterity" {{#if (eq stat.stat 'dexterity')}}selected{{/if}}>{{localize 'VAGABOND.Stat.Dexterity.abbr'}}</option>
                            <option value="awareness" {{#if (eq stat.stat 'awareness')}}selected{{/if}}>{{localize 'VAGABOND.Stat.Awareness.abbr'}}</option>
                            <option value="reason" {{#if (eq stat.stat 'reason')}}selected{{/if}}>{{localize 'VAGABOND.Stat.Reason.abbr'}}</option>
                            <option value="presence" {{#if (eq stat.stat 'presence')}}selected{{/if}}>{{localize 'VAGABOND.Stat.Presence.abbr'}}</option>
                            <option value="luck" {{#if (eq stat.stat 'luck')}}selected{{/if}}>{{localize 'VAGABOND.Stat.Luck.abbr'}}</option>
                        </select>
                        <input type="number" name="system.prerequisites.stats.{{index}}.value" value="{{stat.value}}" min="1" max="10" placeholder="Val">
                        <a class="delete-btn" data-action="removeStatPrerequisite" data-index="{{index}}"><i class="fas fa-trash"></i></a>
                    </div>
                    {{/each}}
                </div>
            </div>
            {{/if}}

            {{!-- Stat OR Groups (only show if exists) --}}
            {{#if item.system.prerequisites.statOrGroups.length}}
            <div class="prereq-group prereq-section-card">
                <div class="group-header">
                    <span><a class="add-btn" data-action="addStatOrGroup" title="Add new OR group"><i class="fas fa-plus-circle"></i></a> Stat OR Groups</span>
                    <div class="header-actions">
                        <a class="clear-btn" data-action="clearAllStatOrGroups" title="Clear all OR groups"><i class="fas fa-times-circle"></i></a>
                    </div>
                </div>
                <div class="prereq-list">
                    {{#each item.system.prerequisites.statOrGroups as |group groupIndex|}}
                    <div class="prereq-or-group">
                        <div class="or-group-header">
                            <span>OR Group {{add groupIndex 1}} ({{group.length}} stats)</span>
                            <a class="delete-btn" data-action="removeStatOrGroup"
                               data-index="{{groupIndex}}" title="Remove this OR group">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                        <div class="or-group-items">
                            {{#each group as |stat statIndex|}}
                            <div class="prereq-row">
                                <select name="system.prerequisites.statOrGroups.{{groupIndex}}.{{statIndex}}.stat">
                                    <option value="might" {{#if (eq stat.stat 'might')}}selected{{/if}}>{{localize 'VAGABOND.Stat.Might.abbr'}}</option>
                                    <option value="dexterity" {{#if (eq stat.stat 'dexterity')}}selected{{/if}}>{{localize 'VAGABOND.Stat.Dexterity.abbr'}}</option>
                                    <option value="awareness" {{#if (eq stat.stat 'awareness')}}selected{{/if}}>{{localize 'VAGABOND.Stat.Awareness.abbr'}}</option>
                                    <option value="reason" {{#if (eq stat.stat 'reason')}}selected{{/if}}>{{localize 'VAGABOND.Stat.Reason.abbr'}}</option>
                                    <option value="presence" {{#if (eq stat.stat 'presence')}}selected{{/if}}>{{localize 'VAGABOND.Stat.Presence.abbr'}}</option>
                                    <option value="luck" {{#if (eq stat.stat 'luck')}}selected{{/if}}>{{localize 'VAGABOND.Stat.Luck.abbr'}}</option>
                                </select>
                                <input type="number" name="system.prerequisites.statOrGroups.{{groupIndex}}.{{statIndex}}.value" value="{{stat.value}}" min="1" max="10" placeholder="Val" style="width: 60px;">
                                <a class="delete-btn"
                                   data-action="removeStatFromOrGroup"
                                   data-group="{{groupIndex}}"
                                   data-stat="{{statIndex}}"
                                   title="Remove stat from OR group">
                                    <i class="fas fa-times"></i>
                                </a>
                            </div>
                            {{/each}}
                            <a class="add-btn-mini"
                               data-action="addStatToOrGroup"
                               data-index="{{groupIndex}}"
                               title="Add stat to this OR group">
                                <i class="fas fa-plus"></i> Add stat to group
                            </a>
                        </div>
                    </div>
                    {{/each}}
                </div>
            </div>
            {{/if}}

            {{!-- Trained Skills (only show if exists) --}}
            {{#if item.system.prerequisites.trainedSkills.length}}
            <div class="prereq-group prereq-section-card">
                <div class="group-header">
                    <span><a class="add-btn" data-action="addTrainedSkillPrerequisite" title="Add skill"><i class="fas fa-plus-circle"></i></a> {{localize 'VAGABOND.Item.Perk.FIELDS.prerequisites.trainedSkills.label'}}</span>
                    <div class="header-actions">
                        <a class="clear-btn" data-action="clearAllTrainedSkills" title="Clear all skills"><i class="fas fa-times-circle"></i></a>
                    </div>
                </div>
                <div class="prereq-list">
                    {{#each item.system.prerequisites.trainedSkills as |skill index|}}
                    <div class="prereq-row">
                        <select name="system.prerequisites.trainedSkills.{{index}}">
                            <optgroup label="Skills">
                                <option value="arcana" {{#if (eq skill 'arcana')}}selected{{/if}}>{{localize 'VAGABOND.Skills.Arcana'}}</option>
                                <option value="craft" {{#if (eq skill 'craft')}}selected{{/if}}>{{localize 'VAGABOND.Skills.Craft'}}</option>
                                <option value="medicine" {{#if (eq skill 'medicine')}}selected{{/if}}>{{localize 'VAGABOND.Skills.Medicine'}}</option>
                                <option value="brawl" {{#if (eq skill 'brawl')}}selected{{/if}}>{{localize 'VAGABOND.Skills.Brawl'}}</option>
                                <option value="finesse" {{#if (eq skill 'finesse')}}selected{{/if}}>{{localize 'VAGABOND.Skills.Finesse'}}</option>
                                <option value="sneak" {{#if (eq skill 'sneak')}}selected{{/if}}>{{localize 'VAGABOND.Skills.Sneak'}}</option>
                                <option value="detect" {{#if (eq skill 'detect')}}selected{{/if}}>{{localize 'VAGABOND.Skills.Detect'}}</option>
                                <option value="mysticism" {{#if (eq skill 'mysticism')}}selected{{/if}}>{{localize 'VAGABOND.Skills.Mysticism'}}</option>
                                <option value="survival" {{#if (eq skill 'survival')}}selected{{/if}}>{{localize 'VAGABOND.Skills.Survival'}}</option>
                                <option value="influence" {{#if (eq skill 'influence')}}selected{{/if}}>{{localize 'VAGABOND.Skills.Influence'}}</option>
                                <option value="leadership" {{#if (eq skill 'leadership')}}selected{{/if}}>{{localize 'VAGABOND.Skills.Leadership'}}</option>
                                <option value="performance" {{#if (eq skill 'performance')}}selected{{/if}}>{{localize 'VAGABOND.Skills.Performance'}}</option>
                            </optgroup>
                            <optgroup label="Weapon Skills">
                                <option value="melee" {{#if (eq skill 'melee')}}selected{{/if}}>{{localize 'VAGABOND.WeaponSkills.Melee'}}</option>
                                <option value="ranged" {{#if (eq skill 'ranged')}}selected{{/if}}>{{localize 'VAGABOND.WeaponSkills.Ranged'}}</option>
                            </optgroup>
                        </select>
                        <a class="delete-btn" data-action="removeTrainedSkillPrerequisite" data-index="{{index}}"><i class="fas fa-trash"></i></a>
                    </div>
                    {{/each}}
                </div>
            </div>
            {{/if}}

            {{!-- Trained Skills OR Groups (only show if exists) --}}
            {{#if item.system.prerequisites.trainedSkillOrGroups.length}}
            <div class="prereq-group prereq-section-card">
                <div class="group-header">
                    <span><a class="add-btn" data-action="addTrainedSkillOrGroup" title="Add new OR group"><i class="fas fa-plus-circle"></i></a> Trained Skill OR Groups</span>
                    <div class="header-actions">
                        <a class="clear-btn" data-action="clearAllTrainedSkillOrGroups" title="Clear all OR groups"><i class="fas fa-times-circle"></i></a>
                    </div>
                </div>
                <div class="prereq-list">
                    {{#each item.system.prerequisites.trainedSkillOrGroups as |group groupIndex|}}
                    <div class="prereq-or-group">
                        <div class="or-group-header">
                            <span>OR Group {{add groupIndex 1}} ({{group.length}} skills)</span>
                            <a class="delete-btn" data-action="removeTrainedSkillOrGroup"
                               data-index="{{groupIndex}}" title="Remove this OR group">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                        <div class="or-group-items">
                            {{#each group as |skill skillIndex|}}
                            <div class="prereq-row">
                                <select name="system.prerequisites.trainedSkillOrGroups.{{groupIndex}}.{{skillIndex}}">
                                    {{#select skill}}
                                    <option value="">-- Select Skill --</option>
                                    <optgroup label="Skills">
                                        <option value="arcana">{{localize 'VAGABOND.Skills.Arcana'}}</option>
                                        <option value="craft">{{localize 'VAGABOND.Skills.Craft'}}</option>
                                        <option value="medicine">{{localize 'VAGABOND.Skills.Medicine'}}</option>
                                        <option value="brawl">{{localize 'VAGABOND.Skills.Brawl'}}</option>
                                        <option value="finesse">{{localize 'VAGABOND.Skills.Finesse'}}</option>
                                        <option value="sneak">{{localize 'VAGABOND.Skills.Sneak'}}</option>
                                        <option value="detect">{{localize 'VAGABOND.Skills.Detect'}}</option>
                                        <option value="mysticism">{{localize 'VAGABOND.Skills.Mysticism'}}</option>
                                        <option value="survival">{{localize 'VAGABOND.Skills.Survival'}}</option>
                                        <option value="influence">{{localize 'VAGABOND.Skills.Influence'}}</option>
                                        <option value="leadership">{{localize 'VAGABOND.Skills.Leadership'}}</option>
                                        <option value="performance">{{localize 'VAGABOND.Skills.Performance'}}</option>
                                    </optgroup>
                                    <optgroup label="Weapon Skills">
                                        <option value="melee">{{localize 'VAGABOND.WeaponSkills.Melee'}}</option>
                                        <option value="ranged">{{localize 'VAGABOND.WeaponSkills.Ranged'}}</option>
                                    </optgroup>
                                    {{/select}}
                                </select>
                                <a class="delete-btn"
                                   data-action="removeSkillFromOrGroup"
                                   data-group="{{groupIndex}}"
                                   data-skill="{{skillIndex}}"
                                   title="Remove skill from OR group">
                                    <i class="fas fa-times"></i>
                                </a>
                            </div>
                            {{/each}}
                            <a class="add-btn-mini"
                               data-action="addSkillToOrGroup"
                               data-index="{{groupIndex}}"
                               title="Add skill to this OR group">
                                <i class="fas fa-plus"></i> Add skill to group
                            </a>
                        </div>
                    </div>
                    {{/each}}
                </div>
            </div>
            {{/if}}

            {{!-- Spells (only show if exists) --}}
            {{#if item.system.prerequisites.spells.length}}
            <div class="prereq-group prereq-section-card">
                <div class="group-header">
                    <span><a class="add-btn" data-action="addSpellPrerequisite" title="Add spell"><i class="fas fa-plus-circle"></i></a> {{localize 'VAGABOND.Item.Perk.FIELDS.prerequisites.spells.label'}}</span>
                    <div class="header-actions">
                        <a class="clear-btn" data-action="clearAllSpells" title="Clear all spells"><i class="fas fa-times-circle"></i></a>
                    </div>
                </div>
                <div class="prereq-list">
                    {{!-- "Has Any Spell" Checkbox --}}
                    <div class="prereq-row">
                        <label class="checkbox-label">
                            <input type="checkbox" name="system.prerequisites.hasAnySpell" {{checked item.system.prerequisites.hasAnySpell}} data-action="toggleHasAnySpell">
                            {{localize 'VAGABOND.Item.Perk.HasAnySpell'}}
                        </label>
                    </div>

                    {{!-- Specific Spell Prerequisites --}}
                    <div class="specific-spell-prerequisites" {{#if item.system.prerequisites.hasAnySpell}}style="display: none;"{{/if}}>
                    {{#each spellPrerequisites as |prereq|}}
                    <div class="prereq-row">
                        <select name="system.prerequisites.spells.{{prereq.index}}">
                            <option value="">{{localize 'VAGABOND.Item.Perk.SelectSpell'}}</option>
                            {{#each prereq.availableSpells as |spell|}}
                                <option value="{{spell.uuid}}" {{#if spell.isSelected}}selected{{/if}}>
                                    {{spell.name}} ({{spell.packLabel}})
                                </option>
                            {{/each}}
                        </select>
                        <a class="delete-btn" data-action="removeSpellPrerequisite" data-index="{{prereq.index}}"><i class="fas fa-trash"></i></a>
                    </div>
                    {{/each}}
                    </div>
                </div>
            </div>
            {{/if}}

            {{!-- Spell OR Groups (only show if exists) --}}
            {{#if item.system.prerequisites.spellOrGroups.length}}
            <div class="prereq-group prereq-section-card">
                <div class="group-header">
                    <span><a class="add-btn" data-action="addSpellOrGroup" title="Add new OR group"><i class="fas fa-plus-circle"></i></a> Spell OR Groups</span>
                    <div class="header-actions">
                        <a class="clear-btn" data-action="clearAllSpellOrGroups" title="Clear all OR groups"><i class="fas fa-times-circle"></i></a>
                    </div>
                </div>
                <div class="prereq-list">
                    {{#each item.system.prerequisites.spellOrGroups as |group groupIndex|}}
                    <div class="prereq-or-group">
                        <div class="or-group-header">
                            <span>OR Group {{add groupIndex 1}} ({{group.length}} spells)</span>
                            <a class="delete-btn" data-action="removeSpellOrGroup"
                               data-index="{{groupIndex}}" title="Remove this OR group">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                        <div class="or-group-items">
                            {{#each group as |spellUuid spellIndex|}}
                            <div class="prereq-row">
                                <select name="system.prerequisites.spellOrGroups.{{groupIndex}}.{{spellIndex}}">
                                    <option value="">{{localize 'VAGABOND.Item.Perk.SelectSpell'}}</option>
                                    {{#each @root.spellPrerequisites.[0].availableSpells as |spell|}}
                                        <option value="{{spell.uuid}}" {{#if (eq spellUuid spell.uuid)}}selected{{/if}}>
                                            {{spell.name}} ({{spell.packLabel}})
                                        </option>
                                    {{/each}}
                                </select>
                                <a class="delete-btn"
                                   data-action="removeSpellFromOrGroup"
                                   data-group="{{groupIndex}}"
                                   data-spell="{{spellIndex}}"
                                   title="Remove spell from OR group">
                                    <i class="fas fa-times"></i>
                                </a>
                            </div>
                            {{/each}}
                            <a class="add-btn-mini"
                               data-action="addSpellToOrGroup"
                               data-index="{{groupIndex}}"
                               title="Add spell to this OR group">
                                <i class="fas fa-plus"></i> Add spell to group
                            </a>
                        </div>
                    </div>
                    {{/each}}
                </div>
            </div>
            {{/if}}

            {{!-- Resources (only show if exists) --}}
            {{#if item.system.prerequisites.resources.length}}
            <div class="prereq-group prereq-section-card">
                <div class="group-header">
                    <span><a class="add-btn" data-action="addResourcePrerequisite" title="Add resource"><i class="fas fa-plus-circle"></i></a> {{localize 'VAGABOND.Item.Perk.FIELDS.prerequisites.resources.label'}}</span>
                    <div class="header-actions">
                        <a class="clear-btn" data-action="clearAllResources" title="Clear all resources"><i class="fas fa-times-circle"></i></a>
                    </div>
                </div>
                <div class="prereq-list">
                    {{#each item.system.prerequisites.resources as |resource index|}}
                    <div class="prereq-row">
                        <select name="system.prerequisites.resources.{{index}}.resourceType">
                            <option value="">{{localize 'VAGABOND.Item.Perk.SelectResource'}}</option>
                            <option value="maxMana" {{#if (eq resource.resourceType 'maxMana')}}selected{{/if}}>{{localize 'VAGABOND.ResourceTypes.MaxMana'}}</option>
                            <option value="manaPerCast" {{#if (eq resource.resourceType 'manaPerCast')}}selected{{/if}}>{{localize 'VAGABOND.ResourceTypes.ManaPerCast'}}</option>
                            <option value="wealth" {{#if (eq resource.resourceType 'wealth')}}selected{{/if}}>{{localize 'VAGABOND.ResourceTypes.Wealth'}}</option>
                            <option value="inventorySlots" {{#if (eq resource.resourceType 'inventorySlots')}}selected{{/if}}>{{localize 'VAGABOND.ResourceTypes.InventorySlots'}}</option>
                            <option value="speed" {{#if (eq resource.resourceType 'speed')}}selected{{/if}}>{{localize 'VAGABOND.ResourceTypes.Speed'}}</option>
                            <option value="maxHP" {{#if (eq resource.resourceType 'maxHP')}}selected{{/if}}>{{localize 'VAGABOND.ResourceTypes.MaxHP'}}</option>
                            <option value="currentLuck" {{#if (eq resource.resourceType 'currentLuck')}}selected{{/if}}>{{localize 'VAGABOND.ResourceTypes.CurrentLuck'}}</option>
                        </select>
                        <input type="number" name="system.prerequisites.resources.{{index}}.minimum" value="{{resource.minimum}}" min="0" placeholder="Min" style="width: 60px;">
                        <a class="delete-btn" data-action="removeResourcePrerequisite" data-index="{{index}}"><i class="fas fa-trash"></i></a>
                    </div>
                    {{/each}}
                </div>
            </div>
            {{/if}}

            {{!-- Resource OR Groups (only show if exists) --}}
            {{#if item.system.prerequisites.resourceOrGroups.length}}
            <div class="prereq-group prereq-section-card">
                <div class="group-header">
                    <span><a class="add-btn" data-action="addResourceOrGroup" title="Add new OR group"><i class="fas fa-plus-circle"></i></a> Resource OR Groups</span>
                    <div class="header-actions">
                        <a class="clear-btn" data-action="clearAllResourceOrGroups" title="Clear all OR groups"><i class="fas fa-times-circle"></i></a>
                    </div>
                </div>
                <div class="prereq-list">
                    {{#each item.system.prerequisites.resourceOrGroups as |group groupIndex|}}
                    <div class="prereq-or-group">
                        <div class="or-group-header">
                            <span>OR Group {{add groupIndex 1}} ({{group.length}} resources)</span>
                            <a class="delete-btn" data-action="removeResourceOrGroup"
                               data-index="{{groupIndex}}" title="Remove this OR group">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                        <div class="or-group-items">
                            {{#each group as |resource resourceIndex|}}
                            <div class="prereq-row">
                                <select name="system.prerequisites.resourceOrGroups.{{groupIndex}}.{{resourceIndex}}.resourceType">
                                    <option value="">{{localize 'VAGABOND.Item.Perk.SelectResource'}}</option>
                                    <option value="maxMana" {{#if (eq resource.resourceType 'maxMana')}}selected{{/if}}>{{localize 'VAGABOND.ResourceTypes.MaxMana'}}</option>
                                    <option value="manaPerCast" {{#if (eq resource.resourceType 'manaPerCast')}}selected{{/if}}>{{localize 'VAGABOND.ResourceTypes.ManaPerCast'}}</option>
                                    <option value="wealth" {{#if (eq resource.resourceType 'wealth')}}selected{{/if}}>{{localize 'VAGABOND.ResourceTypes.Wealth'}}</option>
                                    <option value="inventorySlots" {{#if (eq resource.resourceType 'inventorySlots')}}selected{{/if}}>{{localize 'VAGABOND.ResourceTypes.InventorySlots'}}</option>
                                    <option value="speed" {{#if (eq resource.resourceType 'speed')}}selected{{/if}}>{{localize 'VAGABOND.ResourceTypes.Speed'}}</option>
                                    <option value="maxHP" {{#if (eq resource.resourceType 'maxHP')}}selected{{/if}}>{{localize 'VAGABOND.ResourceTypes.MaxHP'}}</option>
                                    <option value="currentLuck" {{#if (eq resource.resourceType 'currentLuck')}}selected{{/if}}>{{localize 'VAGABOND.ResourceTypes.CurrentLuck'}}</option>
                                </select>
                                <input type="number" name="system.prerequisites.resourceOrGroups.{{groupIndex}}.{{resourceIndex}}.minimum" value="{{resource.minimum}}" min="0" placeholder="Min" style="width: 60px;">
                                <a class="delete-btn"
                                   data-action="removeResourceFromOrGroup"
                                   data-group="{{groupIndex}}"
                                   data-resource="{{resourceIndex}}"
                                   title="Remove resource from OR group">
                                    <i class="fas fa-times"></i>
                                </a>
                            </div>
                            {{/each}}
                            <a class="add-btn-mini"
                               data-action="addResourceToOrGroup"
                               data-index="{{groupIndex}}"
                               title="Add resource to this OR group">
                                <i class="fas fa-plus"></i> Add resource to group
                            </a>
                        </div>
                    </div>
                    {{/each}}
                </div>
            </div>
            {{/if}}

        </div>
    </div>

    <hr class="perk-divider">

    {{!-- 2. Choice Configuration Section --}}
    <div class="perk-choice-config-section">
        <label class="section-header">
            <i class="fas fa-hand-pointer"></i> Choice Configuration
        </label>

        {{!-- Choice Type --}}
        <div class="form-group">
            <label for="choice-type">Type</label>
            <select name="system.choiceConfig.type" id="choice-type">
                <option value="none" {{#if (eq item.system.choiceConfig.type 'none')}}selected{{/if}}>
                    {{localize 'VAGABOND.Item.Perk.ChoiceType.None'}}
                </option>
                <option value="skill" {{#if (eq item.system.choiceConfig.type 'skill')}}selected{{/if}}>
                    {{localize 'VAGABOND.Item.Perk.ChoiceType.Skill'}}
                </option>
                <option value="weaponSkill" {{#if (eq item.system.choiceConfig.type 'weaponSkill')}}selected{{/if}}>
                    {{localize 'VAGABOND.Item.Perk.ChoiceType.WeaponSkill'}}
                </option>
                <option value="stat" {{#if (eq item.system.choiceConfig.type 'stat')}}selected{{/if}}>
                    {{localize 'VAGABOND.Item.Perk.ChoiceType.Stat'}}
                </option>
                <option value="spell" {{#if (eq item.system.choiceConfig.type 'spell')}}selected{{/if}}>
                    {{localize 'VAGABOND.Item.Perk.ChoiceType.Spell'}}
                </option>
            </select>
        </div>

        {{!-- Show config fields only if type is not 'none' --}}
        {{#unless (eq item.system.choiceConfig.type 'none')}}

        {{!-- Selected Choice (Read-Only) --}}
        <div class="form-group">
            <label for="choice-selected">Selected</label>
            <input type="text" name="system.choiceConfig.selected" id="choice-selected" value="{{item.system.choiceConfig.selected}}" readonly placeholder="(Filled automatically)" style="background-color: #f5f5f5;">
        </div>

        {{!-- Target Field --}}
        <div class="form-group">
            <label for="choice-target-field">Target Field</label>
            <input type="text" name="system.choiceConfig.targetField" id="choice-target-field" value="{{item.system.choiceConfig.targetField}}" placeholder="skills.{choice}.trained" style="font-family: monospace;">
            <p class="hint" style="color: #c53030; font-weight: 600;">⚠️ DO NOT include "system." prefix! DataModels handle this automatically.</p>
            <p class="hint">Example: <code>stats.{choice}.bonus</code> or <code>skills.{choice}.trained</code></p>
        </div>

        {{!-- Effect Mode and Value (Same Row) --}}
        <div class="grid grid-2col">
            <div class="form-group">
                <label for="choice-effect-mode">Effect Mode</label>
                <select name="system.choiceConfig.effectMode" id="choice-effect-mode">
                    <option value="0" {{#if (eq item.system.choiceConfig.effectMode 0)}}selected{{/if}}>0: Custom</option>
                    <option value="1" {{#if (eq item.system.choiceConfig.effectMode 1)}}selected{{/if}}>1: Multiply</option>
                    <option value="2" {{#if (eq item.system.choiceConfig.effectMode 2)}}selected{{/if}}>2: Add</option>
                    <option value="3" {{#if (eq item.system.choiceConfig.effectMode 3)}}selected{{/if}}>3: Downgrade</option>
                    <option value="4" {{#if (eq item.system.choiceConfig.effectMode 4)}}selected{{/if}}>4: Upgrade</option>
                    <option value="5" {{#if (eq item.system.choiceConfig.effectMode 5)}}selected{{/if}}>5: Override</option>
                </select>
            </div>
            <div class="form-group">
                <label for="choice-effect-value">Effect Value</label>
                <input type="text" name="system.choiceConfig.effectValue" id="choice-effect-value" value="{{item.system.choiceConfig.effectValue}}" placeholder="1" style="font-family: monospace;">
            </div>
        </div>

        {{!-- Info Accordion --}}
        <div class="help-box">
            <details>
                <summary><i class="fas fa-info-circle"></i> Info & Examples</summary>
                <div class="mode-help">
                    <div class="mode-example">
                        <h4>How It Works</h4>
                        <p>When a player adds this perk, a dialog appears asking them to choose from available options (skills, stats, etc.). The system then creates an Active Effect targeting the selected field.</p>
                    </div>

                    <div class="mode-example">
                        <h4>Target Field Examples</h4>
                        <p class="hint" style="color: #c53030; font-weight: 600; margin-bottom: 0.5rem;">⚠️ DO NOT include "system." prefix!</p>
                        <ul style="margin: 0.25rem 0; padding-left: 1.5rem;">
                            <li><code>skills.{choice}.trained</code> - For skill training</li>
                            <li><code>weaponSkills.{choice}.trained</code> - For weapon skill training</li>
                            <li><code>stats.{choice}.bonus</code> - For stat increase</li>
                            <li><em>(Leave empty for spell selection)</em> - For granting free spells</li>
                        </ul>
                        <p class="hint">Use <code>{choice}</code> as placeholder - it gets replaced with player's selection</p>
                    </div>

                    <div class="mode-example">
                        <h4>Effect Modes</h4>
                        <ul style="margin: 0.25rem 0; padding-left: 1.5rem;">
                            <li><strong>Add (2)</strong> - Add to existing value (use for numeric bonuses like <code>+1</code>)</li>
                            <li><strong>Override (5)</strong> - Replace value entirely (use for <code>trained = true</code>)</li>
                        </ul>
                    </div>

                    <div class="mode-example">
                        <h4>Effect Value Examples</h4>
                        <ul style="margin: 0.25rem 0; padding-left: 1.5rem;">
                            <li><code>true</code> - For boolean fields (trained)</li>
                            <li><code>1</code> - Simple numeric bonus (+1)</li>
                            <li><code>@attributes.level.value</code> - Bonus equal to character level</li>
                            <li><code>floor(@attributes.level.value / 2)</code> - Half level, rounded down</li>
                            <li><code>@stats.might.total</code> - Bonus equal to Might stat</li>
                        </ul>
                    </div>

                    <div class="mode-example">
                        <h4>Complete Examples</h4>
                        <p><strong>New Training (Choose Skill)</strong></p>
                        <ul style="margin: 0.25rem 0; padding-left: 1.5rem; font-size: 0.9em;">
                            <li>Type: <code>skill</code></li>
                            <li>Target Field: <code>skills.{choice}.trained</code></li>
                            <li>Effect Mode: <code>Override (5)</code></li>
                            <li>Effect Value: <code>true</code></li>
                        </ul>

                        <p style="margin-top: 0.75rem;"><strong>Advancement (Choose Stat +1)</strong></p>
                        <ul style="margin: 0.25rem 0; padding-left: 1.5rem; font-size: 0.9em;">
                            <li>Type: <code>stat</code></li>
                            <li>Target Field: <code>stats.{choice}.bonus</code></li>
                            <li>Effect Mode: <code>Add (2)</code></li>
                            <li>Effect Value: <code>1</code></li>
                        </ul>

                        <p style="margin-top: 0.75rem;"><strong>Level-Scaling Stat Bonus</strong></p>
                        <ul style="margin: 0.25rem 0; padding-left: 1.5rem; font-size: 0.9em;">
                            <li>Type: <code>stat</code></li>
                            <li>Target Field: <code>stats.{choice}.bonus</code></li>
                            <li>Effect Mode: <code>Add (2)</code></li>
                            <li>Effect Value: <code>floor(@attributes.level.value / 2)</code></li>
                        </ul>

                        <p style="margin-top: 0.75rem;"><strong>Learn New Spell (Grants Free Spell)</strong></p>
                        <ul style="margin: 0.25rem 0; padding-left: 1.5rem; font-size: 0.9em;">
                            <li>Type: <code>spell</code></li>
                            <li>Target Field: <em>(Leave empty)</em></li>
                            <li>Effect Mode: <em>(Not used)</em></li>
                            <li>Effect Value: <em>(Leave empty)</em></li>
                        </ul>
                        <p class="hint" style="font-size: 0.85em; margin-top: 0.25rem;">
                            <strong>Note:</strong> For spell selection, the chosen spell is automatically added to the character when the perk is granted. No Active Effect configuration needed - the spell itself is the benefit!
                        </p>
                    </div>
                </div>
            </details>
        </div>

        {{/unless}}
    </div>
</section>