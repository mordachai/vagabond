{{! Class Details Tab - Unified scrolling container }}
<section
  class='tab details {{tab.cssClass}}'
  data-group='primary'
  data-tab='details'
>
  {{! Unified content container with single scroll }}
  <div class='class-item-content'>
    {{! Description Section }}
    <div>
      <label class='resource-label'>{{localize 'VAGABOND.Item.Tabs.Description'}}</label>
      <div class='class-description'>
        {{#if editable}}
          <prose-mirror name="system.description" data-document-uuid="{{item.uuid}}" value="{{system.description}}" collaborate="true" toggled="true">
            {{{enrichedDescription}}}
          </prose-mirror>
        {{else}}
          <div>{{{enrichedDescription}}}</div>
        {{/if}}
      </div>
    </div>

    {{! Key Stats Section }}
    <div class='key-stats-section mt-20'>
      <h3>{{localize "VAGABOND.Terms.KeyStat"}}</h3>

      <div class='form-group-stacked'>
        <div class='flex-row flex-wrap gap-5'>
          {{#each system.keyStats as |statKey index|}}
            <div class='skill-tag key-stat-tag'>
              <span>{{localize (lookup @root.config.stats statKey)}}</span>
              {{#if @root.editable}}
                <a data-action="removeKeyStat" data-index="{{index}}">
                  <i class="fas fa-times"></i>
                </a>
              {{/if}}
            </div>
          {{/each}}
        </div>

        {{#if editable}}
          <div class='flex-row mt-5'>
            <select id="key-stat-select">
              <option value=''>{{localize "VAGABOND.UI.Labels.SelectStat"}}</option>
              <option value='might'>{{localize "VAGABOND.Stat.Might.long"}}</option>
              <option value='dexterity'>{{localize "VAGABOND.Stat.Dexterity.long"}}</option>
              <option value='reason'>{{localize "VAGABOND.Stat.Reason.long"}}</option>
              <option value='awareness'>{{localize "VAGABOND.Stat.Awareness.long"}}</option>
              <option value='presence'>{{localize "VAGABOND.Stat.Presence.long"}}</option>
              <option value='luck'>{{localize "VAGABOND.Stat.Luck.long"}}</option>
            </select>
            <button type="button" data-action="addKeyStat" class="btn-sm">
              <i class="fas fa-plus"></i> {{localize "VAGABOND.UI.Buttons.AddStat"}}
            </button>
          </div>
        {{/if}}
      </div>
    </div>

    {{! Skill Training Section }}
    <div class='skill-training-section mt-20'>
      <h3>{{localize "VAGABOND.UI.Sections.SkillTraining"}}</h3>
      
      <div class='form-group-stacked'>
        <label>{{localize "VAGABOND.UI.Labels.GuaranteedSkills"}}</label>
        <div class='flex-row flex-wrap gap-5'>
          {{#each system.skillGrant.guaranteed as |skillKey index|}}
            <div class='skill-tag'>
              <span>{{localize (lookup @root.config.weaponSkills skillKey)}}</span>
              {{#if @root.editable}}
                <a data-action="removeGuaranteedSkill" 
                data-index="{{index}}"><i class="fas fa-times"></i></a>
              {{/if}}
            </div>
          {{/each}}
        </div>

        {{#if editable}}
          <div class='flex-row mt-5'>
            <select id="guaranteed-skill-select">
              {{#each config.weaponSkills as |label key|}}
                <option value="{{key}}">{{localize label}}</option>
              {{/each}}
            </select>
            <button type="button" 
            data-action="addGuaranteedSkill" 
            class="btn-sm">
              <i class="fas fa-plus"></i> {{localize "VAGABOND.UI.Buttons.AddSkill"}}
            </button>
          </div>
        {{/if}}
      </div>

      <div class='skill-choices mt-10'>
        <div class='flex-row justify-between mb-5'>
          <label>{{localize "VAGABOND.UI.Labels.SkillChoices"}}</label>
          {{#if editable}}
            <button type="button" 
            data-action="addSkillChoiceGroup" 
            class="btn-sm">
              <i class="fas fa-plus"></i> {{localize "VAGABOND.UI.Buttons.AddChoiceGroup"}}
            </button>
          {{/if}}
        </div>

        {{#each system.skillGrant.choices as |choice index|}}
          <div class='choice-group-card p-10 border mb-5'>
            <div class='flex-row justify-between align-right mb-5'>
              <strong>{{localize "VAGABOND.UI.Labels.Group"}} n. {{add index 1}}</strong>
              <a data-action="removeSkillChoiceGroup" 
              data-index="{{index}}" 
              class="text-danger"><i class="fas fa-trash"></i></a>
            </div>
            
            {{! Choices class skills }}
            <div class='class-choice-container'>
              <div class='form-group'>
                <label>{{localize "VAGABOND.UI.Labels.Count"}}</label>
                <input type="number" 
                      name="system.skillGrant.choices.{{index}}.count" {{!-- Added name for auto-save --}}
                      class="count-input" 
                      value="{{choice.count}}" 
                      min="0">
              </div>
              <div class='form-group'>
                <label>{{localize "VAGABOND.UI.Labels.RestrictedPool"}}<span class="text-sm"> ({{localize "VAGABOND.UI.Hints.EmptyForAny"}})</span></label>
                <input type="text" 
                      name="system.skillGrant.choices.{{index}}.pool" {{!-- Added name for auto-save --}}
                      class="pool-input"
                      value="{{#each choice.pool}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}" 
                      placeholder="e.g. detect, influence, leadership">
              </div>
              
              {{#if @root.editable}}
              <div class="flex-row justify-end mt-5">
                <button type="button" data-action="saveChoices" class="btn-sm">
                  <i class="fas fa-save"></i> {{localize "VAGABOND.UI.Buttons.UpdateGroup"}}
                </button>
              </div>
              {{/if}}
            </div>
          </div>
        {{/each}}
      </div>
    </div>

    {{! Level Features Section }}
    <div class='level-features-section mt-20'>
      <h3>{{localize "VAGABOND.UI.Sections.LevelFeatures"}}</h3>

      {{#each levelGroups as |group|}}
        <div class='level-group'>
          <div class='level-header title-with-button'>
            <h4 class='m-0'>{{localize "VAGABOND.UI.Sections.Level"}} {{group.level}}</h4>
            {{#if @root.editable}}
              <button
                type='button'
                class='item-control btn-sm'
                data-action='addLevelFeature'
                data-level='{{group.level}}'
                data-tooltip='Add Feature to Level {{group.level}}'
              >
                <i class='fas fa-plus'></i> Add Feature
              </button>
            {{/if}}
          </div>

          {{! Spells and Mana Display/Edit }}
          {{#if @root.system.isSpellcaster}}
            <div class='level-traits-display'>
              <div class='trait-badge-inline'>
                <strong>Mana:</strong> <span>{{group.maxMana}}</span>
              </div>
              <div class='trait-badge-inline'>
                <strong>Spells:</strong>
                {{#if @root.editable}}
                  <input
                    type='number'
                    name='system.levelSpells.{{group.spellsIndex}}.spells'
                    value='{{group.spells}}'
                    min='0'
                    data-dtype='Number'
                    class='spells-per-level-input'
                    placeholder='0'
                  />
                  <input type='hidden' name='system.levelSpells.{{group.spellsIndex}}.level' value='{{group.level}}' />
                {{else}}
                  <span>{{group.spells}}</span>
                {{/if}}
              </div>
            </div>
          {{/if}}

          {{#if group.features.length}}
            <ol class='features-list m-0 pl-20'>
              {{#each group.features as |feature|}}
                <li class='feature-item mb-10' data-feature-index='{{feature.index}}'>
                  <div class='feature-content'>
                    {{#if @root.editable}}
                      <div class='flex-center-gap-10 mb-5'>
                        <input
                          type='text'
                          name='system.levelFeatures.{{feature.index}}.name'
                          value='{{feature.name}}'
                          placeholder='Feature Name'
                          data-dtype='String'
                          class='flex-1 feature-title'
                        />
                        <a
                          class='item-control'
                          data-action='removeLevelFeature'
                          data-feature-index='{{feature.index}}'
                          data-tooltip='Remove Feature'
                        >
                          <i class='fas fa-trash'></i>
                        </a>
                      </div>
                      <div class='level-feature-description'>
                        <prose-mirror
                          name='system.levelFeatures.{{feature.index}}.description'
                          data-document-uuid='{{@root.item.uuid}}'
                          value='{{feature.description}}'
                          collaborate='true'
                          toggled='true'
                        >
                          {{{feature.enrichedDescription}}}
                        </prose-mirror>
                      </div>
                      <input
                        type='hidden'
                        name='system.levelFeatures.{{feature.index}}.level'
                        value='{{feature.level}}'
                      />

                      {{! Configuration fields for grants }}
                      <details class='feature-grants mt-10'>
                        <summary><small>⚙️ Configure Grants</small></summary>
                        <div class='grants-content p-5'>

                          {{! Stat Bonus Points }}
                          <div class='form-group'>
                            <label>Stat Bonus Points:</label>
                            <input type='number' name='system.levelFeatures.{{feature.index}}.statBonusPoints' value='{{feature.statBonusPoints}}' min='0' max='10' style='width: 60px;' />
                            <small class='hint'>Each point gives +1 to any stat &lt;7 (player chooses)</small>
                          </div>

                          {{! Extra Training }}
                          <div class='form-group mt-10'>
                            <label>Extra Training:</label>
                            <input type='number' name='system.levelFeatures.{{feature.index}}.extraTraining' value='{{feature.extraTraining}}' min='0' max='10' style='width: 60px;' />
                            <small class='hint'>Additional skill training choices (any skill)</small>
                          </div>

                          {{! Required Spells }}
                          <div class='form-group mt-10'>
                            <label>Required Spells:</label>
                            <div class='grants-list-container'>
                              {{#if feature.enrichedSpells.length}}
                                <ul class='grants-list'>
                                  {{#each feature.enrichedSpells as |spell spellIndex|}}
                                    <li class='grant-tag'>
                                      <img src='{{spell.img}}' alt='{{spell.name}}' class='grant-tag-icon' />
                                      <span class='grant-tag-label'>{{spell.name}}</span>
                                      <a class='grant-tag-remove' data-action='removeFeatureSpell' data-feature-index='{{../index}}' data-spell-index='{{spellIndex}}'>
                                        <i class='fas fa-times'></i>
                                      </a>
                                    </li>
                                  {{/each}}
                                </ul>
                              {{/if}}
                              <div class='grants-add-controls'>
                                <select class='grants-select' data-feature-index='{{feature.index}}' data-grant-type='spell'>
                                  <option value=''>-- Select Spell --</option>
                                  {{!-- Options will be populated via JS --}}
                                </select>
                                <button type='button' class='btn-sm' data-action='addFeatureSpell' data-feature-index='{{feature.index}}'>
                                  <i class='fas fa-plus'></i> Add Spell
                                </button>
                              </div>
                            </div>
                          </div>

                          {{! Perk Amount }}
                          <div class='form-group mt-10'>
                            <label>Perks Amount:</label>
                            <input type='number' name='system.levelFeatures.{{feature.index}}.perkAmount' value='{{feature.perkAmount}}' min='0' max='10' style='width: 60px;' />
                            <small class='hint'>Number of perks this feature allows choosing</small>
                          </div>

                          {{! Allowed Perks }}
                          <div class='form-group mt-10'>
                            <label>Allowed Perks:</label>
                            <small class='hint'>Empty list = Any perk allowed</small>
                            <div class='grants-list-container'>
                              {{#if feature.enrichedPerks.length}}
                                <ul class='grants-list'>
                                  {{#each feature.enrichedPerks as |perk perkIndex|}}
                                    <li class='grant-tag'>
                                      <img src='{{perk.img}}' alt='{{perk.name}}' class='grant-tag-icon' />
                                      <span class='grant-tag-label'>{{perk.name}}</span>
                                      <a class='grant-tag-remove' data-action='removeFeaturePerk' data-feature-index='{{../index}}' data-perk-index='{{perkIndex}}'>
                                        <i class='fas fa-times'></i>
                                      </a>
                                    </li>
                                  {{/each}}
                                </ul>
                              {{else}}
                                <p class='text-info'><small><i class='fas fa-info-circle'></i> Any perk can be selected</small></p>
                              {{/if}}
                              <div class='grants-add-controls'>
                                <select class='grants-select' data-feature-index='{{feature.index}}' data-grant-type='perk'>
                                  <option value=''>-- Select Perk --</option>
                                  {{!-- Options will be populated via JS --}}
                                </select>
                                <button type='button' class='btn-sm' data-action='addFeaturePerk' data-feature-index='{{feature.index}}'>
                                  <i class='fas fa-plus'></i> Add Perk
                                </button>
                              </div>
                            </div>
                          </div>

                        </div>
                      </details>
                    {{else}}
                      <strong class='feature-title'>{{feature.name}}</strong>
                      {{#if feature.enrichedDescription}}
                        <div class='mt-5'>{{{feature.enrichedDescription}}}</div>
                      {{/if}}
                    {{/if}}
                  </div>
                </li>
              {{/each}}
            </ol>
          {{else}}
            <p class='m-0 italic text-muted'>
              No features at this level.{{#if @root.editable}} Click "Add Feature" to add one.{{/if}}
            </p>
          {{/if}}
        </div>
      {{/each}}
    </div>
  </div>
</section>
