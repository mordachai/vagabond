{{! Class Details Tab - Unified scrolling container }}
<section
  class='tab details {{tab.cssClass}}'
  data-group='primary'
  data-tab='details'
>
  {{! Unified content container with single scroll }}
  <div class='class-item-content'>
    {{! Description Section }}
    <div>
      <label class='resource-label'>{{localize 'VAGABOND.Item.Tabs.Description'}}</label>
      <div class='class-description'>
        {{#if editable}}
          <prose-mirror name="system.description" data-document-uuid="{{item.uuid}}" value="{{system.description}}" collaborate="true" toggled="true">
            {{{enrichedDescription}}}
          </prose-mirror>
        {{else}}
          <div>{{{enrichedDescription}}}</div>
        {{/if}}
      </div>
    </div>

    {{! Skill Training Section }}
    <div class='skill-training-section mt-20'>
      <h3>{{localize "VAGABOND.UI.Sections.SkillTraining"}}</h3>
      
      <div class='form-group-stacked'>
        <label>{{localize "VAGABOND.UI.Labels.GuaranteedSkills"}}</label>
        <div class='flex-row flex-wrap gap-5'>
          {{#each system.skillGrant.guaranteed as |skillKey index|}}
            <div class='skill-tag'>
              <span>{{localize (lookup @root.config.weaponSkills skillKey)}}</span>
              {{#if @root.editable}}
                <a data-action="removeGuaranteedSkill" 
                data-index="{{index}}"><i class="fas fa-times"></i></a>
              {{/if}}
            </div>
          {{/each}}
        </div>

        {{#if editable}}
          <div class='flex-row mt-5'>
            <select id="guaranteed-skill-select">
              {{#each config.weaponSkills as |label key|}}
                <option value="{{key}}">{{localize label}}</option>
              {{/each}}
            </select>
            <button type="button" 
            data-action="addGuaranteedSkill" 
            class="btn-sm">
              <i class="fas fa-plus"></i> {{localize "VAGABOND.UI.Buttons.AddSkill"}}
            </button>
          </div>
        {{/if}}
      </div>

      <div class='skill-choices mt-10'>
        <div class='flex-row justify-between mb-5'>
          <label>{{localize "VAGABOND.UI.Labels.SkillChoices"}}</label>
          {{#if editable}}
            <button type="button" 
            data-action="addSkillChoiceGroup" 
            class="btn-sm">
              <i class="fas fa-plus"></i> {{localize "VAGABOND.UI.Buttons.AddChoiceGroup"}}
            </button>
          {{/if}}
        </div>

        {{#each system.skillGrant.choices as |choice index|}}
          <div class='choice-group-card p-10 border mb-5'>
            <div class='flex-row justify-between align-right mb-5'>
              <strong>{{localize "VAGABOND.UI.Labels.Group"}} n. {{add index 1}}</strong>
              <a data-action="removeSkillChoiceGroup" 
              data-index="{{index}}" 
              class="text-danger"><i class="fas fa-trash"></i></a>
            </div>
            
            {{! Choices class skills }}
            <div class='class-choice-container'>
              <div class='form-group'>
                <label>{{localize "VAGABOND.UI.Labels.Count"}}</label>
                <input type="number" 
                      name="system.skillGrant.choices.{{index}}.count" {{!-- Added name for auto-save --}}
                      class="count-input" 
                      value="{{choice.count}}" 
                      min="0">
              </div>
              <div class='form-group'>
                <label>{{localize "VAGABOND.UI.Labels.RestrictedPool"}}<span class="text-sm"> ({{localize "VAGABOND.UI.Hints.EmptyForAny"}})</span></label>
                <input type="text" 
                      name="system.skillGrant.choices.{{index}}.pool" {{!-- Added name for auto-save --}}
                      class="pool-input"
                      value="{{#each choice.pool}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}" 
                      placeholder="e.g. detect, influence, leadership">
              </div>
              
              {{#if @root.editable}}
              <div class="flex-row justify-end mt-5">
                <button type="button" data-action="saveChoices" class="btn-sm">
                  <i class="fas fa-save"></i> {{localize "VAGABOND.UI.Buttons.UpdateGroup"}}
                </button>
              </div>
              {{/if}}
            </div>
          </div>
        {{/each}}
      </div>
    </div>

    {{! Level Features Section }}
    <div class='level-features-section mt-20'>
      <h3>{{localize "VAGABOND.UI.Sections.LevelFeatures"}}</h3>

      {{#each levelGroups as |group|}}
        <div class='level-group'>
          <div class='level-header title-with-button'>
            <h4 class='m-0'>{{localize "VAGABOND.UI.Sections.Level"}} {{group.level}}</h4>
            {{#if @root.editable}}
              <button
                type='button'
                class='item-control btn-sm'
                data-action='addLevelFeature'
                data-level='{{group.level}}'
                data-tooltip='Add Feature to Level {{group.level}}'
              >
                <i class='fas fa-plus'></i> Add Feature
              </button>
            {{/if}}
          </div>

          {{! Spells and Mana Display/Edit }}
          {{#if @root.system.isSpellcaster}}
            <div class='level-traits-display'>
              <div class='trait-badge-inline'>
                <strong>Mana:</strong> <span>{{group.maxMana}}</span>
              </div>
              <div class='trait-badge-inline'>
                <strong>Spells:</strong>
                {{#if @root.editable}}
                  <input
                    type='number'
                    name='system.levelSpells.{{group.spellsIndex}}.spells'
                    value='{{group.spells}}'
                    min='0'
                    data-dtype='Number'
                    class='spells-per-level-input'
                    placeholder='0'
                  />
                  <input type='hidden' name='system.levelSpells.{{group.spellsIndex}}.level' value='{{group.level}}' />
                {{else}}
                  <span>{{group.spells}}</span>
                {{/if}}
              </div>
            </div>
          {{/if}}

          {{#if group.features.length}}
            <ol class='features-list m-0 pl-20'>
              {{#each group.features as |feature|}}
                <li class='feature-item mb-10' data-feature-index='{{feature.index}}'>
                  <div class='feature-content'>
                    {{#if @root.editable}}
                      <div class='flex-center-gap-10 mb-5'>
                        <input
                          type='text'
                          name='system.levelFeatures.{{feature.index}}.name'
                          value='{{feature.name}}'
                          placeholder='Feature Name'
                          data-dtype='String'
                          class='flex-1 feature-title'
                        />
                        <a
                          class='item-control'
                          data-action='removeLevelFeature'
                          data-feature-index='{{feature.index}}'
                          data-tooltip='Remove Feature'
                        >
                          <i class='fas fa-trash'></i>
                        </a>
                      </div>
                      <div class='level-feature-description'>
                        <prose-mirror
                          name='system.levelFeatures.{{feature.index}}.description'
                          data-document-uuid='{{@root.item.uuid}}'
                          value='{{feature.description}}'
                          collaborate='true'
                          toggled='true'
                        >
                          {{{feature.enrichedDescription}}}
                        </prose-mirror>
                      </div>
                      <input
                        type='hidden'
                        name='system.levelFeatures.{{feature.index}}.level'
                        value='{{feature.level}}'
                      />
                    {{else}}
                      <strong class='feature-title'>{{feature.name}}</strong>
                      {{#if feature.enrichedDescription}}
                        <div class='mt-5'>{{{feature.enrichedDescription}}}</div>
                      {{/if}}
                    {{/if}}
                  </div>
                </li>
              {{/each}}
            </ol>
          {{else}}
            <p class='m-0 italic text-muted'>
              No features at this level.{{#if @root.editable}} Click "Add Feature" to add one.{{/if}}
            </p>
          {{/if}}
        </div>
      {{/each}}
    </div>
  </div>
</section>
