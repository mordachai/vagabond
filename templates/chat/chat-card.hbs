{{! chat-card.hbs }}
<div class="vagabond-chat-card-v2" data-card-type="{{type}}">

    {{!-- 1. Character Name --}}
    <h4 class="actor-name-header">{{alias}}</h4>

    {{!-- 2. Main Card Body --}}
    <div class="card-body">
        
        {{!-- A. HEADER (Icon + Title + Tags) --}}
        <header class="card-header">
            <div class="header-icon">
                <img src="{{icon}}" alt="{{title}}">
            </div>
            <div class="header-info">
                <h3 class="header-title">{{title}}</h3>
                
                {{!-- UNIFIED METADATA BAR (Range, Mana, Ammo - NO SKILL HERE) --}}
                {{#if metadataTags.length}}
                <div class="metadata-tags-row">
                    {{#each metadataTags}}
                    <div class="meta-tag {{this.cssClass}}" title="{{this.title}}">
                        {{#if this.icon}}<i class="{{this.icon}}"></i>{{/if}}
                        {{#if this.label}}<span>{{this.label}}</span>{{/if}}
                    </div>
                    {{/each}}
                </div>
                {{/if}}
            </div>
        </header>

        {{!-- B. MODIFIER BADGE --}}
        {{#if isFavored}}
        <div class="modifier-badge favored">
            <span>{{localize "VAGABOND.Roll.Favored"}}</span>
        </div>
        {{else if isHindered}}
        <div class="modifier-badge hindered">
            <span>{{localize "VAGABOND.Roll.Hindered"}}</span>
        </div>
        {{/if}}

        {{!-- C. ROLL STRIP --}}
        {{#if hasRoll}}
        <section class="roll-strip">
            <div class="roll-info-group">
                {{!-- SKILL LABEL (Moved here: "FINESSE", "MELEE", etc.) --}}
                {{#if rollSkillLabel}}
                <div class="roll-skill-label">{{rollSkillLabel}}</div>
                {{/if}}

                {{!-- RESULT BANNER --}}
                <div class="roll-result-banner {{#if (or (eq outcome 'success') (eq outcome 'HIT'))}}result-hit{{else}}result-miss{{/if}}">
                    <span class="roll-value">{{rollTotal}}</span>
                    <span class="roll-vs">vs</span>
                    <span class="roll-target">{{difficulty}}</span>
                    <span class="roll-outcome-text">{{outcome}}</span>
                </div>
            </div>

            {{!-- DICE VISUALS --}}
            <div class="roll-dice-container">
                {{{rollDiceDisplay}}}
            </div>
        </section>
        {{/if}}

        {{!-- D. CONTENT BODY --}}
        <section class="content-body">
            
            {{!-- Damage Section --}}
            {{#if damage}}
                {{> "systems/vagabond/templates/chat/damage-display.hbs"}}
            {{/if}}

            {{!-- Description Text --}}
            {{#if description}}
            <div class="card-description">
                {{{description}}}
            </div>
            {{/if}}

            {{!-- FOOTER --}}
            <footer class="card-actions">
                {{!-- 1. Action Buttons (Save / Apply Direct) --}}
                {{#if footerActions.length}}
                <div class="action-buttons-container">
                    {{#each footerActions}}
                        {{{this}}}
                    {{/each}}
                </div>
                {{/if}}

                {{!-- 2. Defend Options Accordion --}}
                {{!-- We check the flag set in the Master Method --}}
                {{#if showDefendOptions}}
                <div class="defend-info-box">
                    <div class="defend-header">
                        <i class="fas fa-shield-alt"></i>
                        <span>{{localize "VAGABOND.DefendMechanics.DefendingTitle"}}</span>
                        <i class="fas fa-chevron-down expand-icon"></i>
                    </div>
                    <div class="defend-content">
                         <p>
                            <strong>{{localize "VAGABOND.DefendMechanics.DodgeTitle"}}:</strong> 
                            {{localize "VAGABOND.DefendMechanics.DodgeDescription"}}
                        </p>
                        <p>
                            <strong>{{localize "VAGABOND.DefendMechanics.BlockTitle"}}:</strong> 
                            {{localize "VAGABOND.DefendMechanics.BlockDescription"}}
                        </p>
                    </div>
                </div>
                {{/if}}
            </footer>
        </section>
    </div>
</div>