{{! chat-card.hbs }}
<div class="vagabond-chat-card-v2" data-card-type="{{type}}">

    {{!-- 1. Character Name --}}
    {{!-- <h4 class="actor-name-header">{{alias}}</h4> --}}

    {{!-- 2. Main Card Body --}}
    <div class="card-body">
        
        {{!-- A. HEADER (Icon + Title + Tags) --}}
        <header class="card-header">
            <div class="header-icon">
                <img src="{{icon}}" alt="{{title}}">
            </div>
            <div class="header-info">
                <h3 class="header-title">{{title}}</h3>
                
                <div class="metadata-tags-row">
                    
                    {{!-- 1. STANDARD TAGS (Range, Mana, etc.) --}}
                    {{#each standardTags}}
                        <div class="meta-tag {{this.cssClass}}" title="{{this.title}}" {{{this.extraAttributes}}}>
                            {{#if this.icon}}<i class="{{this.icon}}"></i>{{/if}}
                            {{#if this.label}}<span>{{this.label}}</span>{{/if}}
                        </div>
                        {{!-- Add Separator unless it's the last standard tag --}}
                        {{#unless @last}}<span class="tag-separator">//</span>{{/unless}}
                    {{/each}}

                    {{!-- Separator between Standard and Properties (if both exist) --}}
                    {{#if (and standardTags.length propertyTags.length)}}
                        <span class="tag-separator">//</span>
                    {{/if}}

                    {{!-- 2. PROPERTIES TRIGGER (Clickable Group) --}}
                    {{#if propertyTags.length}}
                        <div class="meta-tag tag-property-group" data-action="toggleProperties" title="{{localize 'VAGABOND.Weapon.Property.ViewPropertiesLabel'}}">
                            {{#each propertyTags}}
                                <span>{{this.label}}</span>{{#unless @last}},{{/unless}}
                            {{/each}}
                        </div>
                    {{/if}}

                </div>
            </div>
        </header>

        {{!-- [MOVED HERE] PROPERTIES ACCORDION CONTENT --}}
        {{!-- Opens right below the header tags, before the roll strip --}}
        {{#if propertyDetails.length}}
        <div class="metadata-item-expandable">
            <div class="metadata-content">
                <ul>
                {{#each propertyDetails}}
                    <li><strong>{{this.name}}:</strong> {{this.hint}}</li>
                {{/each}}
                </ul>
            </div>
        </div>
        {{/if}}

        {{!-- B. MODIFIER BADGE --}}
        {{#if isFavored}}
        <div class="modifier-badge favored">
            <span>{{localize "VAGABOND.Roll.Favored"}}</span>
        </div>
        {{else if isHindered}}
        <div class="modifier-badge hindered">
            <span>{{localize "VAGABOND.Roll.Hindered"}}</span>
        </div>
        {{/if}}

        {{!-- C. ROLL STRIP --}}
        {{#if hasRoll}}
        <section class="roll-strip">
            <div class="roll-info-group">
                {{!-- SKILL LABEL --}}
                {{#if rollSkillLabel}}
                <div class="roll-skill-label">{{rollSkillLabel}}</div>
                {{/if}}

                {{!-- CRIT LABEL FOR SAVES --}}
                {{!-- {{#if isCritical}}
                <div class="roll-crit-label">{{localize "VAGABOND.Item.Spell.FIELDS.crit.label"}}!</div>
                {{/if}} --}}

                {{!-- RESULT BANNER --}}
                <div class="roll-result-banner {{#if (or (eq outcome 'success') (eq outcome 'HIT') (eq outcome 'PASS'))}}result-hit{{else}}result-miss{{/if}}">
                    <span class="roll-value">{{rollTotal}}</span>
                    <span class="roll-vs">vs</span>
                    <span class="roll-target">{{difficulty}}</span>
                    <span class="roll-outcome-text">{{outcome}}</span>
                </div>
            </div>

            {{!-- DICE VISUALS --}}
            <div class="roll-dice-container">
                {{{rollDiceDisplay}}}
            </div>
        </section>
        {{/if}}

        {{!-- D. CONTENT BODY --}}
        <section class="content-body">

            {{!-- Description Text --}}
            {{#if description}}
            <div class="card-description">
                {{{description}}}
            </div>
            {{/if}}

            {{!-- Damage Section --}}
            {{#if damage}}
                {{> "systems/vagabond/templates/chat/damage-display.hbs"}}
            {{/if}}

            {{!-- FOOTER --}}
            <footer class="card-actions">
                {{!-- Action Buttons (includes defend options via footerActions) --}}
                {{#if footerActions.length}}
                <div class="action-buttons-container">
                    {{#each footerActions}}
                        {{{this}}}
                    {{/each}}
                </div>
                {{/if}}
            </footer>
        </section>
    </div>
</div>