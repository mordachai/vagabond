{{! NPC Sheet Main Content }}
<div class='npc-content'>

  {{! Senses }}
  {{#unless (and system.locked (not system.senses))}}
    <div class='npc-senses-section'>
      <div class='npc-detail-row'>
        <label class='npc-field-label'>{{localize "VAGABOND.Actor.NPC.FIELDS.senses.label"}}</label>
        {{#if system.locked}}
          <div class='npc-field-display'>{{system.senses}}</div>
        {{else}}
          <input
            type='text'
            name='system.senses'
            value='{{system.senses}}'
            data-dtype='String'
            class='npc-text-input'
            placeholder='Darksight, Blindsight...'
          />
        {{/if}}
      </div>
    </div>
  {{/unless}}

  {{! Immunities, Weaknesses, Status Immunities }}
  <div class='npc-resistances-section'>

    {{#if system.locked}}
      {{! LOCKED MODE — display selected values as inline text }}
      {{#if system.immunities.length}}
        <div class='npc-detail-row'>
          <label class='npc-field-label'>{{localize "VAGABOND.Actor.NPC.FIELDS.immunities.label"}}</label>
          <div class='npc-immunity-text'>
            {{#each system.immunities as |immunity index|}}
              <i class='{{lookup ../config.damageTypeIcons immunity}} damage-type-icon-prefix'></i>{{localize (lookup ../config.damageTypes immunity)}}{{#unless @last}}, {{/unless}}
            {{/each}}
          </div>
        </div>
      {{/if}}
      {{#if system.weaknesses.length}}
        <div class='npc-detail-row'>
          <label class='npc-field-label'>{{localize "VAGABOND.Actor.NPC.FIELDS.weaknesses.label"}}</label>
          <div class='npc-immunity-text'>
            {{#each system.weaknesses as |weakness index|}}
              <i class='{{lookup ../config.damageTypeIcons weakness}} damage-type-icon-prefix'></i>{{localize (lookup ../config.allWeaknessTypes weakness)}}{{#unless @last}}, {{/unless}}
            {{/each}}
          </div>
        </div>
      {{/if}}
      {{#if system.statusImmunities.length}}
        <div class='npc-detail-row'>
          <label class='npc-field-label'>{{localize "VAGABOND.Actor.NPC.FIELDS.statusImmunities.label"}}</label>
          <div class='npc-immunity-text'>
            {{#each system.statusImmunities as |status index|}}
              <span class='npc-status-inline'><img class='status-condition-icon' src='{{lookup ../config.statusConditionIcons status}}' alt='{{status}}' />{{localize (lookup ../config.statusConditions status)}}</span>{{#unless @last}}, {{/unless}}
            {{/each}}
          </div>
        </div>
      {{/if}}

    {{else}}
      {{! UNLOCKED MODE — single dropdown with 3 sections }}
      <details class='npc-immunity-dropdown npc-resistances-dropdown'>
        <summary class='npc-immunity-toggle'>
          <i class='fas fa-chevron-down'></i>
          <span>{{localize "VAGABOND.Actor.NPC.Sections.Resistances"}}</span>
        </summary>
        <div class='npc-immunity-checkboxes npc-resistance-panel'>

          {{! Damage Immunities }}
          <div class='npc-resistance-group' data-save-target='system.immunities'>
            <h5 class='npc-resistance-group-header'>{{localize "VAGABOND.Actor.NPC.FIELDS.immunities.label"}}</h5>
            {{#each config.damageTypes as |label key|}}
              {{#unless (eq key '-')}}
                <label class='npc-immunity-checkbox-item'>
                  <input type='checkbox' value='{{key}}' {{#if (contains ../system.immunities key)}}checked{{/if}}>
                  <i class='{{lookup ../config.damageTypeIcons key}} damage-type-icon-prefix'></i>
                  <span>{{localize label}}</span>
                </label>
              {{/unless}}
            {{/each}}
          </div>

          {{! Damage Weaknesses }}
          <div class='npc-resistance-group' data-save-target='system.weaknesses'>
            <h5 class='npc-resistance-group-header'>{{localize "VAGABOND.Actor.NPC.FIELDS.weaknesses.label"}}</h5>
            {{#each config.allWeaknessTypes as |label key|}}
              {{#unless (eq key '-')}}
                <label class='npc-immunity-checkbox-item'>
                  <input type='checkbox' value='{{key}}' {{#if (contains ../system.weaknesses key)}}checked{{/if}}>
                  <i class='{{lookup ../config.damageTypeIcons key}} damage-type-icon-prefix'></i>
                  <span>{{localize label}}</span>
                </label>
              {{/unless}}
            {{/each}}
          </div>

          {{! Status Immunities }}
          <div class='npc-resistance-group' data-save-target='system.statusImmunities'>
            <h5 class='npc-resistance-group-header'>{{localize "VAGABOND.Actor.NPC.FIELDS.statusImmunities.label"}}</h5>
            {{#each config.statusConditions as |label key|}}
              <label class='npc-immunity-checkbox-item'>
                <input type='checkbox' value='{{key}}' {{#if (contains ../system.statusImmunities key)}}checked{{/if}}>
                <img class='status-condition-icon' src='{{lookup ../config.statusConditionIcons key}}' alt='{{key}}' />
                <span>{{localize label}}</span>
              </label>
            {{/each}}
          </div>

        </div>
      </details>

      {{! Tags for all selected items, grouped }}
      {{#if system.immunities.length}}
        <div class='npc-tag-group'>
          <span class='npc-tag-group-label'>{{localize "VAGABOND.Actor.NPC.FIELDS.immunities.label"}}</span>
          {{#each system.immunities as |immunity index|}}
            <span class='npc-immunity-tag'>
              <i class='{{lookup ../config.damageTypeIcons immunity}} damage-type-icon-prefix'></i>
              {{localize (lookup ../config.damageTypes immunity)}}
              <i class='fas fa-times' data-action='removeImmunity' data-immunity='{{immunity}}'></i>
            </span>
          {{/each}}
        </div>
      {{/if}}
      {{#if system.weaknesses.length}}
        <div class='npc-tag-group'>
          <span class='npc-tag-group-label'>{{localize "VAGABOND.Actor.NPC.FIELDS.weaknesses.label"}}</span>
          {{#each system.weaknesses as |weakness index|}}
            <span class='npc-immunity-tag npc-weakness-tag'>
              <i class='{{lookup ../config.damageTypeIcons weakness}} damage-type-icon-prefix'></i>
              {{localize (lookup ../config.allWeaknessTypes weakness)}}
              <i class='fas fa-times' data-action='removeWeakness' data-weakness='{{weakness}}'></i>
            </span>
          {{/each}}
        </div>
      {{/if}}
      {{#if system.statusImmunities.length}}
        <div class='npc-tag-group'>
          <span class='npc-tag-group-label'>{{localize "VAGABOND.Actor.NPC.FIELDS.statusImmunities.label"}}</span>
          {{#each system.statusImmunities as |status index|}}
            <span class='npc-immunity-tag npc-status-tag'>
              <img class='status-condition-icon' src='{{lookup ../config.statusConditionIcons status}}' alt='{{status}}' />
              {{localize (lookup ../config.statusConditions status)}}
              <i class='fas fa-times' data-action='removeStatusImmunity' data-status='{{status}}'></i>
            </span>
          {{/each}}
        </div>
      {{/if}}

    {{/if}}

  </div>

  {{! Actions Section }}
  <section class='npc-section npc-actions'>
    <h4 class='npc-section-title'>{{localize "VAGABOND.Actor.NPC.Sections.Actions"}}</h4>
    <div class='npc-section-content'>
      <div class='npc-actions-list'>
        {{#if system.locked}}
          {{! VIEW MODE }}
          {{#if system.actions}}
            {{#each system.actions as |action index|}}
              {{#if action.name}}
                <div class='npc-action-view' data-action-index='{{index}}'>
                  <div class='action-name-line'>
                    <strong>
                      <span class='action-name' data-action='clickActionName' data-index='{{index}}'>{{action.name}}</span>{{#if action.note}} [{{action.note}}]{{/if}}{{#if action.recharge}} ({{localize "VAGABOND.Actor.NPC.Action.Recharge"}} {{{lookup (lookup @root.enrichedActions index) 'rechargeFormatted'}}}){{/if}}
                    </strong>
                    {{#if (or action.flatDamage action.rollDamage action.damageType)}}
                      {{#if action.damageType}}
                        {{#unless (eq action.damageType '-')}}
                          <span class='action-damage-type'><i class='{{lookup @root.config.damageTypeIcons action.damageType}} damage-type-icon-prefix'></i>{{localize (lookup @root.config.damageTypes action.damageType)}}</span>
                        {{/unless}}
                      {{/if}}
                      {{#if action.flatDamage}}
                        <span class='action-damage-flat'>{{action.flatDamage}}</span>
                      {{/if}}
                      {{#if (and action.flatDamage action.rollDamage)}} / {{/if}}
                        {{#if action.rollDamage}}
                          <span class='action-damage-roll'>({{action.rollDamage}})</span>
                        {{/if}}
                      {{/if}}
                      {{#if action.extraInfo}}
                        <span class='action-extra-info'>{{{lookup (lookup @root.enrichedActions index) 'extraInfoFormatted'}}}</span>
                      {{/if}}
                  </div>
                </div>
              {{/if}}
            {{/each}}
          {{/if}}
        {{else}}
          {{! EDIT MODE - Buffered Editing: Using data-field instead of name to prevent auto-save on every keystroke }}
          {{#if system.actions}}
            {{#each system.actions as |action index|}}
              <div class='npc-action-edit accordion-item {{#unless action.name}}expanded{{/unless}}' data-action-index='{{index}}' data-accordion-id='action-{{index}}'>
                {{#if action.name}}
                  <div class='action-edit-header accordion-header' data-action='toggleActionAccordion' data-index='{{index}}' role='button' tabindex='0' aria-expanded='false'>
                    <span class='action-edit-name'>{{action.name}}</span>
                    <i class='fas fa-chevron-right accordion-icon'></i>
                  </div>
                {{/if}}
                <div class='action-edit-content accordion-content {{#if action.name}}collapsed{{else}}open{{/if}}'>
                  <div class='action-edit-row'>
                    <label>{{localize "VAGABOND.Actor.NPC.Action.Name"}}:</label>
                    <div class='action-name-with-remove'>
                      <input type='text' data-field='name' value='{{action.name}}' placeholder='Action Name' class='npc-text-input' />
                      <button type='button' class='action-remove-btn' data-action='removeAction' data-index='{{index}}' title='Remove Action'>
                        <i class='fas fa-trash'></i>
                      </button>
                    </div>
                  </div>
                  {{#if action.name}}
                  <div class='action-edit-row'>
                    <label>{{localize "VAGABOND.Actor.NPC.Action.Note"}}:</label>
                    <input type='text' data-field='note' value='{{action.note}}' placeholder='Note' class='npc-text-input' />
                  </div>
                  <div class='action-edit-row action-edit-row-split'>
                    <div class='action-edit-col'>
                      <label>{{localize "VAGABOND.Actor.NPC.Action.Recharge"}}:</label>
                      <input type='text' data-field='recharge' value='{{action.recharge}}' placeholder='1/Day or Cd6' class='npc-text-input' />
                    </div>
                    <div class='action-edit-col'>
                      <label>{{localize "VAGABOND.Actor.NPC.Action.AttackType"}}:</label>
                      <select data-field='attackType' class='npc-field-input'>
                        <option value='melee' {{#if (eq action.attackType 'melee')}}selected{{/if}}>{{localize "VAGABOND.AttackTypes.Melee"}}</option>
                        <option value='ranged' {{#if (eq action.attackType 'ranged')}}selected{{/if}}>{{localize "VAGABOND.AttackTypes.Ranged"}}</option>
                        <option value='castClose' {{#if (eq action.attackType 'castClose')}}selected{{/if}}>{{localize "VAGABOND.AttackTypes.CastClose"}}</option>
                        <option value='castRanged' {{#if (eq action.attackType 'castRanged')}}selected{{/if}}>{{localize "VAGABOND.AttackTypes.CastRanged"}}</option>
                      </select>
                    </div>
                  </div>
                  <div class='action-edit-row action-edit-row-split'>
                    <div class='action-edit-col'>
                      <label>{{localize "VAGABOND.Actor.NPC.Action.FlatDamage"}}:</label>
                      <input type='text' data-field='flatDamage' value='{{action.flatDamage}}' placeholder='4' class='npc-number-input' size='3' />
                    </div>
                    <div class='action-edit-col'>
                      <label>{{localize "VAGABOND.Actor.NPC.Action.RollDamage"}}:</label>
                      <input type='text' data-field='rollDamage' value='{{action.rollDamage}}' placeholder='2d8' class='npc-text-input' />
                    </div>
                  </div>
                  <div class='action-edit-row'>
                    <label>{{localize "VAGABOND.Actor.NPC.Action.DamageType"}}:</label>
                    <select data-field="damageType" class="npc-field-input">
                      <option value="-" {{#if (or (eq action.damageType "-") (not action.damageType))}}selected{{/if}}>-</option>
                      <option value="acid" {{#if (eq action.damageType "acid")}}selected{{/if}}>{{localize "VAGABOND.DamageTypes.Acid"}}</option>
                      <option value="fire" {{#if (eq action.damageType "fire")}}selected{{/if}}>{{localize "VAGABOND.DamageTypes.Fire"}}</option>
                      <option value="shock" {{#if (eq action.damageType "shock")}}selected{{/if}}>{{localize "VAGABOND.DamageTypes.Shock"}}</option>
                      <option value="poison" {{#if (eq action.damageType "poison")}}selected{{/if}}>{{localize "VAGABOND.DamageTypes.Poison"}}</option>
                      <option value="cold" {{#if (eq action.damageType "cold")}}selected{{/if}}>{{localize "VAGABOND.DamageTypes.Cold"}}</option>
                      <option value="blunt" {{#if (eq action.damageType "blunt")}}selected{{/if}}>{{localize "VAGABOND.DamageTypes.Blunt"}}</option>
                      <option value="piercing" {{#if (eq action.damageType "piercing")}}selected{{/if}}>{{localize "VAGABOND.DamageTypes.Piercing"}}</option>
                      <option value="slashing" {{#if (eq action.damageType "slashing")}}selected{{/if}}>{{localize "VAGABOND.DamageTypes.Slashing"}}</option>
                      <option value="physical" {{#if (eq action.damageType "physical")}}selected{{/if}}>{{localize "VAGABOND.DamageTypes.Physical"}}</option>
                      <option value="necrotic" {{#if (eq action.damageType "necrotic")}}selected{{/if}}>{{localize "VAGABOND.DamageTypes.Necrotic"}}</option>
                      <option value="psychic" {{#if (eq action.damageType "psychic")}}selected{{/if}}>{{localize "VAGABOND.DamageTypes.Psychic"}}</option>
                      <option value="magical" {{#if (eq action.damageType "magical")}}selected{{/if}}>{{localize "VAGABOND.DamageTypes.Magical"}}</option>
                      <option value="healing" {{#if (eq action.damageType "healing")}}selected{{/if}}>{{localize "VAGABOND.DamageTypes.Healing"}}</option>
                      <option value="recover" {{#if (eq action.damageType "recover")}}selected{{/if}}>{{localize "VAGABOND.DamageTypes.Recover"}}</option>
                      <option value="recharge" {{#if (eq action.damageType "recharge")}}selected{{/if}}>{{localize "VAGABOND.DamageTypes.Recharge"}}</option>
                    </select>
                  </div>
                  <div class='action-edit-row'>
                    <label>{{localize "VAGABOND.Actor.NPC.Action.ExtraInfo"}}:</label>
                    <textarea data-field='extraInfo' rows='2' placeholder='Extra information...' class='npc-field-input'>{{action.extraInfo}}</textarea>
                  </div>
                  {{/if}}
                </div>
              </div>
            {{/each}}
          {{/if}}
          <div class='action-add-row'>
            <button type='button' class='action-add-btn' data-action='addAction'>
              <i class='fas fa-plus'></i> {{localize "VAGABOND.Actor.NPC.Action.Add"}}
            </button>
          </div>
        {{/if}}
      </div>
    </div>
  </section>

  {{! Abilities Section }}
  <section class='npc-section npc-abilities'>
    <h4 class='npc-section-title'>{{localize "VAGABOND.Actor.NPC.Sections.Abilities"}}</h4>
    <div class='npc-section-content'>
      <div class='npc-abilities-list'>
        {{#if system.locked}}
          {{! VIEW MODE }}
          {{#if system.abilities}}
            {{#each system.abilities as |ability index|}}
              {{#if ability.name}}
                <div class='npc-ability-view' data-ability-index='{{index}}'>
                  <span class='ability-name' data-action='clickAbilityName' data-index='{{index}}'>{{ability.name}}</span>{{#if ability.description}}:
                  <span class='ability-description'>{{{ability.enrichedDescription}}}</span>{{/if}}
                </div>
              {{/if}}
            {{/each}}
          {{/if}}
        {{else}}
          {{! EDIT MODE - Buffered Editing }}
          {{#if system.abilities}}
            {{#each system.abilities as |ability index|}}
              <div class='npc-ability-edit accordion-item {{#unless ability.name}}expanded{{/unless}}' data-ability-index='{{index}}' data-accordion-id='ability-{{index}}'>
                {{#if ability.name}}
                  <div class='ability-edit-header accordion-header' data-action='toggleAbilityAccordion' data-index='{{index}}' role='button' tabindex='0' aria-expanded='false'>
                    <span class='ability-edit-name'>{{ability.name}}</span>
                    <i class='fas fa-chevron-right accordion-icon'></i>
                  </div>
                {{/if}}
                <div class='ability-edit-content accordion-content {{#if ability.name}}collapsed{{else}}open{{/if}}'>
                  <div class='ability-edit-row'>
                    <label>{{localize "VAGABOND.Actor.NPC.Ability.Name"}}</label>
                    <div class='ability-name-with-remove'>
                      <input type='text' data-field='name' value='{{ability.name}}' placeholder='Ability Name' class='npc-text-input' />
                      <button type='button' class='ability-remove-btn' data-action='removeAbility' data-index='{{index}}' title='Remove Ability'>
                        <i class='fas fa-trash'></i>
                      </button>
                    </div>
                  </div>
                  {{#if ability.name}}
                    <div class='ability-edit-row'>
                      <label>{{localize "VAGABOND.Actor.NPC.Ability.Description"}}</label>
                      <textarea data-field='description' rows='3' placeholder='Description (dice like d6 or 2d8 will be clickable)' class='npc-text-input'>{{ability.description}}</textarea>
                    </div>
                  {{/if}}
                </div>
              </div>
            {{/each}}
          {{/if}}
          <div class='ability-add-row'>
            <button type='button' class='ability-add-btn' data-action='addAbility'>
              <i class='fas fa-plus'></i> {{localize "VAGABOND.Actor.NPC.Ability.Add"}}
            </button>
          </div>
        {{/if}}
      </div>
    </div>
  </section>

  {{! Effects Section - Accordion }}
  <section class='npc-section npc-effects'>
    <h4 class='npc-section-title accordion-header' data-action='toggleEffectsAccordion'>
      {{localize "VAGABOND.Actor.NPC.Sections.Effects"}}
      <i class='fas fa-chevron-right accordion-icon'></i>
    </h4>
    <div class='npc-section-content accordion-content collapsed'>
      <ol class='effects-list'>
        {{#each effects as |section sid|}}
          <li
            class='effects-header flexrow'
            data-effect-type='{{section.type}}'
          >
            <div class='effect-name flexrow'>
              {{localize section.label}}
            </div>
            <div class='effect-source'>
              {{localize 'VAGABOND.Effect.Source'}}
            </div>
            <div class='effect-source'>{{localize 'EFFECT.TABS.duration'}}</div>
            <div class='effect-controls flexrow'>
              <a
                class='effect-control clickable'
                data-action='createDoc'
                data-document-class='ActiveEffect'
                data-origin="{{@root.actor.uuid}}"
                data-img="icons/svg/aura.svg"
                {{#if (eq section.type "inactive")}}
                  data-disabled="true"
                {{else if (eq section.type "temporary")}}
                  data-duration.rounds="1"
                {{/if}}
                data-tooltip='{{localize "DOCUMENT.Create" type='Effect'}}'
              >
                <i class='fas fa-plus'></i>
                {{localize 'DOCUMENT.New' type='Effect'}}
              </a>
            </div>
          </li>

          <ol class='effect-list'>
            {{#each section.effects as |effect|}}
              <li
                class='effect effect flexrow draggable'
                data-effect-id='{{effect.id}}'
                data-parent-id='{{effect.parent.id}}'
                data-document-class='ActiveEffect'
              >
                <div class='effect-name flexrow'>
                  <img class='effect-image' src='{{effect.img}}' height="24" width="24"/>
                  <div>{{effect.name}}</div>
                </div>
                <div class='effect-source'>{{effect.sourceName}}</div>
                <div class='effect-duration'>{{effect.duration.label}}</div>
                <div class='effect-controls flexrow'>
                  {{#if @root.editable}}
                  <a
                    class='effect-control'
                    data-action='toggleEffect'
                    data-tooltip='{{localize "VAGABOND.Effect.Toggle"}}'
                  >
                    <i class='fas {{#if effect.disabled}}fa-check{{else}}fa-times{{/if}}'></i>
                  </a>
                  {{/if}}
                  <a
                    class='effect-control'
                    data-action='viewDoc'
                    data-tooltip='{{localize "DOCUMENT.Update" type='Effect'}}'
                  >
                    <i class='fas fa-edit'></i>
                  </a>
                  {{#if @root.editable}}
                  <a
                    class='effect-control'
                    data-action='deleteDoc'
                    data-tooltip='{{localize "DOCUMENT.Delete" type='Effect'}}'
                  >
                    <i class='fas fa-trash'></i>
                  </a>
                  {{/if}}
                </div>
              </li>
            {{/each}}
          </ol>
        {{/each}}
      </ol>
    </div>
  </section>

</div>