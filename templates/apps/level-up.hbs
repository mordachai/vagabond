<div class="level-up-wrapper">
  {{! Tab Bar }}
  <nav class="level-up-tabs">
    {{#each tabs}}
      <button class="level-up-tab {{#if active}}active{{/if}}" data-action="changeTab" data-tab="{{id}}">
        <i class="{{icon}}"></i> {{label}}
      </button>
    {{/each}}

    {{! GM Override Toggle }}
    {{#if isGM}}
      <label class="gm-override-toggle" data-tooltip="Override even/odd level rules for stat & perk tabs">
        <input type="checkbox" {{#if gmOverride}}checked{{/if}} data-action="toggleGmOverride" />
        <i class="fas fa-user-shield"></i> GM
      </label>
    {{/if}}
  </nav>

  {{! Tab Content }}
  <div class="level-up-tab-content">

    {{! ─── XP Questionnaire ─── }}
    {{#if (eq activeTab 'questionnaire')}}
      <section class="lu-tab lu-questionnaire">
        <div class="lu-xp-layout">
          {{! Left: Questions }}
          <div class="lu-xp-left">
            <h3><i class="fas fa-star"></i> Session XP Questionnaire</h3>
            <p class="lu-instruction">Check each question that applies to this session:</p>

            <div class="lu-questions">
              {{#each questionnaire.questions}}
                <label class="lu-question {{#if checked}}checked{{/if}}" data-action="toggleQuestion" data-index="{{index}}">
                  <span class="lu-checkbox">
                    {{#if checked}}<i class="fas fa-check-square"></i>{{else}}<i class="far fa-square"></i>{{/if}}
                  </span>
                  <span class="lu-question-text">{{label}}</span>
                </label>
              {{/each}}
            </div>

            <div class="lu-actions">
              {{#unless questionnaire.xpAwarded}}
                <button type="button" class="lu-btn lu-btn-primary" data-action="awardXP" {{#unless questionnaire.xpGained}}disabled{{/unless}}>
                  <i class="fas fa-star"></i> Award {{questionnaire.xpGained}} XP
                </button>
              {{else}}
                <span class="lu-awarded-badge"><i class="fas fa-check"></i> XP Awarded</span>
              {{/unless}}
            </div>
          </div>

          {{! Right: Stats Panel }}
          <div class="lu-xp-right">
            <div class="lu-stats-panel">
              <div class="lu-stats-panel-level">
                <span class="lu-stats-label">Level</span>
                <span class="lu-stats-big">{{questionnaire.currentLevel}}</span>
              </div>

              <div class="lu-stats-panel-divider"></div>

              <div class="lu-stats-panel-xp">
                <span class="lu-stats-label">Experience</span>
                <div class="lu-xp-numbers">
                  <span class="lu-xp-current {{#if questionnaire.canLevelUp}}lu-ready{{/if}}">{{questionnaire.projectedXP}}</span>
                  <span class="lu-xp-separator">/</span>
                  <span class="lu-xp-required">{{questionnaire.xpRequired}}</span>
                </div>
                <div class="lu-xp-bar">
                  <div class="lu-xp-bar-fill {{#if questionnaire.canLevelUp}}lu-ready{{/if}}" style="width: {{questionnaire.xpProgress}}%"></div>
                </div>
              </div>

              <div class="lu-stats-panel-divider"></div>

              <div class="lu-stats-panel-next">
                <span class="lu-stats-label">Next Level</span>
                <span class="lu-stats-big lu-next-level">{{questionnaire.nextLevel}}</span>
              </div>

              {{#if questionnaire.xpGained}}
                <div class="lu-stats-panel-divider"></div>
                <div class="lu-stats-panel-gain">
                  <span class="lu-stats-label">Session XP</span>
                  <span class="lu-stats-gain">+{{questionnaire.xpGained}}</span>
                </div>
              {{/if}}
            </div>
          </div>
        </div>
      </section>
    {{/if}}

    {{! ─── Summary ─── }}
    {{#if (eq activeTab 'summary')}}
      <section class="lu-tab lu-summary">
        <h3><i class="fas fa-scroll"></i> Level {{newLevel}} Summary</h3>

        {{#unless levelApplied}}
          <p class="lu-warning"><i class="fas fa-exclamation-triangle"></i>{{localize "VAGABOND.LevelUp.HintLevelUp"}}</p>
        {{/unless}}

        {{#if summary.hasFeatures}}
          <div class="lu-features">
            <h4>New Features</h4>
            {{#each summary.features}}
              <div class="lu-feature">
                <strong>{{name}}</strong>
                {{#if description}}<div class="lu-feature-desc">{{{description}}}</div>{{/if}}
                {{#if statBonusPoints}}<span class="lu-feature-tag"><i class="fas fa-chart-bar"></i> +{{statBonusPoints}} stat point(s)</span>{{/if}}
                {{#if perkAmount}}<span class="lu-feature-tag"><i class="fas fa-gem"></i> +{{perkAmount}} perk(s)</span>{{/if}}
                {{#if extraTraining}}<span class="lu-feature-tag"><i class="fas fa-graduation-cap"></i> +{{extraTraining}} training(s)</span>{{/if}}
              </div>
            {{/each}}
          </div>
        {{/if}}

        {{#if summary.hasChecklist}}
          <div class="lu-checklist">
            <h4>To Do</h4>
            {{#each summary.checklist}}
              <div class="lu-checklist-item {{#if done}}done{{/if}}">
                <span class="lu-check-icon">
                  {{#if done}}<i class="fas fa-check-circle"></i>{{else}}<i class="far fa-circle"></i>{{/if}}
                </span>
                <span class="lu-check-label" data-action="changeTab" data-tab="{{tab}}">{{label}}</span>
              </div>
            {{/each}}
          </div>
        {{/if}}

        {{!-- Apply button is in the persistent footer --}}
      </section>
    {{/if}}

    {{! ─── Stat Increase ─── }}
    {{#if (eq activeTab 'stats')}}
      <section class="lu-tab lu-stats">
        <h3><i class="fas fa-chart-bar"></i> Stat Increase</h3>
        <p class="lu-instruction">Choose one stat to increase by +1 (max 7):</p>

        <div class="lu-stat-grid">
          {{#each statIncrease.stats}}
            <button type="button"
                    class="lu-stat-card {{#if isSelected}}selected{{/if}} {{#if isMaxed}}maxed{{/if}}"
                    data-action="selectStat"
                    data-stat="{{key}}"
                    {{#if isMaxed}}disabled{{/if}}>
              <span class="lu-stat-name">{{label}}</span>
              <span class="lu-stat-value">{{current}}</span>
              {{#if isSelected}}<span class="lu-stat-delta">+1</span>{{/if}}
              {{#if isMaxed}}<span class="lu-stat-max">MAX</span>{{/if}}
            </button>
          {{/each}}
        </div>

        {{! Derived Stats Preview }}
        <div class="lu-derived-stats">
          <h4>Character Stats</h4>
          <div class="lu-derived-grid lu-grid-3col">
            <div class="lu-derived-item {{#if statIncrease.derived.hpChanged}}lu-changed{{/if}}">
              <span class="lu-derived-label">HP</span>
              <span class="lu-derived-dots"></span>
              <span class="lu-derived-value">{{#if statIncrease.derived.hpChanged}}<span class="lu-old-val">{{statIncrease.derived.hp}}</span> {{statIncrease.derived.hpPreview}}{{else}}{{statIncrease.derived.hp}}{{/if}}</span>
            </div>
            {{#if statIncrease.derived.isSpellcaster}}
              <div class="lu-derived-item {{#if statIncrease.derived.manaChanged}}lu-changed{{/if}}">
                <span class="lu-derived-label">Mana Max</span>
                <span class="lu-derived-dots"></span>
                <span class="lu-derived-value">{{#if statIncrease.derived.manaChanged}}<span class="lu-old-val">{{statIncrease.derived.manaMax}}</span> {{statIncrease.derived.manaMaxPreview}}{{else}}{{statIncrease.derived.manaMax}}{{/if}}</span>
              </div>
              <div class="lu-derived-item {{#if statIncrease.derived.manaCastChanged}}lu-changed{{/if}}">
                <span class="lu-derived-label">Mana/Cast</span>
                <span class="lu-derived-dots"></span>
                <span class="lu-derived-value">{{#if statIncrease.derived.manaCastChanged}}<span class="lu-old-val">{{statIncrease.derived.manaCast}}</span> {{statIncrease.derived.manaCastPreview}}{{else}}{{statIncrease.derived.manaCast}}{{/if}}</span>
              </div>
            {{/if}}
            <div class="lu-derived-item {{#if statIncrease.derived.luckChanged}}lu-changed{{/if}}">
              <span class="lu-derived-label">Luck Pool</span>
              <span class="lu-derived-dots"></span>
              <span class="lu-derived-value">{{#if statIncrease.derived.luckChanged}}<span class="lu-old-val">{{statIncrease.derived.luckPool}}</span> {{statIncrease.derived.luckPreview}}{{else}}{{statIncrease.derived.luckPool}}{{/if}}</span>
            </div>
            <div class="lu-derived-item {{#if statIncrease.derived.inventoryChanged}}lu-changed{{/if}}">
              <span class="lu-derived-label">Inventory</span>
              <span class="lu-derived-dots"></span>
              <span class="lu-derived-value">{{#if statIncrease.derived.inventoryChanged}}<span class="lu-old-val">{{statIncrease.derived.inventory}}</span> {{statIncrease.derived.inventoryPreview}}{{else}}{{statIncrease.derived.inventory}}{{/if}}</span>
            </div>
            <div class="lu-derived-item {{#if statIncrease.derived.speedChanged}}lu-changed{{/if}}">
              <span class="lu-derived-label">Speed</span>
              <span class="lu-derived-dots"></span>
              <span class="lu-derived-value">{{#if statIncrease.derived.speedChanged}}<span class="lu-old-val">{{statIncrease.derived.speed}}</span> {{statIncrease.derived.speedPreview}}{{else}}{{statIncrease.derived.speed}}{{/if}}</span>
            </div>
          </div>

          {{! Saves }}
          <h4>Saves</h4>
          <div class="lu-derived-grid lu-grid-3col">
            {{#each statIncrease.derived.saves}}
              <div class="lu-derived-item {{#if changed}}lu-changed{{/if}}">
                <span class="lu-derived-label">{{label}}{{#if statAbbr}} <span class="lu-stat-abbr">[{{statAbbr}}]</span>{{/if}}</span>
                <span class="lu-derived-dots"></span>
                <span class="lu-derived-value">{{#if changed}}<span class="lu-old-val">{{value}}</span> {{previewValue}}{{else}}{{value}}{{/if}}</span>
              </div>
            {{/each}}
          </div>

          {{! Skills }}
          <h4>Skills</h4>
          <div class="lu-derived-grid lu-grid-4col">
            {{#each statIncrease.derived.skills}}
              <div class="lu-derived-item {{#if trained}}lu-trained{{/if}} {{#if changed}}lu-changed{{/if}}">
                <span class="lu-derived-label">
                  {{#if trained}}<strong>{{/if}}
                  {{label}}{{#if statAbbr}} <span class="lu-stat-abbr">[{{statAbbr}}]</span>{{/if}}
                  {{#if trained}}</strong>{{/if}}
                </span>
                <span class="lu-derived-dots"></span>
                <span class="lu-derived-value">{{#if changed}}<span class="lu-old-val">{{value}}</span> {{previewValue}}{{else}}{{value}}{{/if}}</span>
              </div>
            {{/each}}
          </div>

          {{! Weapon Skills }}
          <h4>Weapon Skills</h4>
          <div class="lu-derived-grid lu-grid-4col">
            {{#each statIncrease.derived.weaponSkills}}
              <div class="lu-derived-item {{#if trained}}lu-trained{{/if}} {{#if changed}}lu-changed{{/if}}">
                <span class="lu-derived-label">
                  {{#if trained}}<strong>{{/if}}
                  {{label}}{{#if statAbbr}} <span class="lu-stat-abbr">[{{statAbbr}}]</span>{{/if}}
                  {{#if trained}}</strong>{{/if}}
                </span>
                <span class="lu-derived-dots"></span>
                <span class="lu-derived-value">{{#if changed}}<span class="lu-old-val">{{value}}</span> {{previewValue}}{{else}}{{value}}{{/if}}</span>
              </div>
            {{/each}}
          </div>
        </div>
      </section>
    {{/if}}

    {{! ─── Perks ─── }}
    {{#if (eq activeTab 'perks')}}
      <section class="lu-tab lu-perks">
        <div class="lu-perks-header">
          <h3><i class="fas fa-gem"></i> Choose a Perk</h3>
          {{#if perks.hiddenCount}}
            <button type="button" class="lu-btn lu-btn-small" data-action="toggleShowAllPerks">
              {{#if perks.showAllPerks}}
                <i class="fas fa-eye-slash"></i> Hide Unqualified ({{perks.hiddenCount}})
              {{else}}
                <i class="fas fa-eye"></i> Show All ({{perks.hiddenCount}} hidden)
              {{/if}}
            </button>
          {{/if}}
        </div>

        {{! Tray (chosen perk) }}
        {{#if perks.hasChosen}}
          <div class="lu-tray">
            <div class="lu-tray-item">
              <img src="{{perks.chosenPerk.img}}" alt="" class="lu-tray-img" />
              <span class="lu-tray-name">{{perks.chosenPerk.name}}</span>
              {{#if perks.chosenPerk.choiceLabel}}
                <span class="lu-tray-choice">({{perks.chosenPerk.choiceLabel}})</span>
              {{/if}}
              <button type="button" class="lu-tray-remove" data-action="removePerk">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        {{/if}}

        <div class="lu-two-col">
          {{! Perk List }}
          <div class="lu-list">
            {{#each perks.availablePerks}}
              <div class="lu-list-item {{#if isPreviewing}}previewing{{/if}} {{#if isChosen}}chosen{{/if}} {{#unless prerequisitesMet}}prereq-fail{{/unless}}"
                   data-action="selectPerk" data-uuid="{{uuid}}">
                <img src="{{img}}" alt="" class="lu-list-img" />
                <span class="lu-list-name">{{name}}</span>
                {{#if isOwned}}<span class="lu-badge taken">Taken{{#if ownedCount}} x{{ownedCount}}{{/if}}</span>{{/if}}
                {{#unless prerequisitesMet}}<span class="lu-badge prereq"><i class="fas fa-lock"></i></span>{{/unless}}
              </div>
            {{/each}}
          </div>

          {{! Preview Panel }}
          <div class="lu-preview">
            {{#if perks.previewItem}}
              <div class="lu-preview-header">
                <img src="{{perks.previewItem.img}}" alt="" class="lu-preview-img" />
                <h4>{{perks.previewItem.name}}</h4>
              </div>
              {{#if perks.previewItem.hasPrereqs}}
                <div class="lu-prereq-list">
                  <strong>Prerequisites:</strong>
                  <ul>
                    {{#each perks.previewItem.allPrereqs}}
                      <li class="{{#if met}}prereq-met{{else}}prereq-unmet{{/if}}">
                        <i class="fas {{#if met}}fa-check-circle{{else}}fa-times-circle{{/if}}"></i>
                        {{text}}
                      </li>
                    {{/each}}
                  </ul>
                </div>
              {{/if}}
              <div class="lu-preview-body">{{{perks.previewItem.enrichedDescription}}}</div>
              {{#unless perks.hasChosen}}
                <button type="button" class="lu-btn lu-btn-primary" data-action="addPerk" data-uuid="{{perks.previewItem.uuid}}">
                  <i class="fas fa-plus"></i> Select Perk
                  {{#unless perks.previewItem.prerequisitesMet}}
                    <span class="lu-btn-note">(prereqs not met)</span>
                  {{/unless}}
                </button>
              {{/unless}}
            {{else}}
              <p class="lu-placeholder">Select a perk to preview</p>
            {{/if}}
          </div>
        </div>
      </section>
    {{/if}}

    {{! ─── Spells ─── }}
    {{#if (eq activeTab 'spells')}}
      <section class="lu-tab lu-spells">
        <h3><i class="fas fa-hat-wizard"></i> Learn New Spells</h3>
        <p class="lu-instruction">Choose {{spells.maxNewSpells}} new spell(s) ({{spells.currentCount}}/{{spells.maxNewSpells}} selected):</p>

        {{! Tray (chosen spells) }}
        {{#if spells.chosenSpells}}
          <div class="lu-tray">
            {{#each spells.chosenSpells}}
              <div class="lu-tray-item">
                <img src="{{img}}" alt="" class="lu-tray-img" />
                <span class="lu-tray-name">{{name}}</span>
                <button type="button" class="lu-tray-remove" data-action="removeSpell" data-uuid="{{uuid}}">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            {{/each}}
          </div>
        {{/if}}

        <div class="lu-two-col">
          {{! Spell List }}
          <div class="lu-list">
            {{#each spells.availableSpells}}
              <div class="lu-list-item {{#if isPreviewing}}previewing{{/if}} {{#if isChosen}}chosen{{/if}} {{#if isOwned}}owned{{/if}} {{#if isRequired}}required{{/if}}"
                   data-action="selectSpell" data-uuid="{{uuid}}">
                <img src="{{img}}" alt="" class="lu-list-img" />
                <span class="lu-list-name">{{name}}</span>
                {{#if baseDamage}}<span class="lu-spell-info">{{baseDamage}}</span>{{/if}}
                {{#if damageType}}<span class="lu-spell-dmg"><i class="{{damageTypeIcon}}"></i></span>{{/if}}
                {{#if isOwned}}<span class="lu-badge owned">Known</span>{{/if}}
                {{#if isRequired}}<span class="lu-badge required">Required</span>{{/if}}
              </div>
            {{/each}}
          </div>

          {{! Preview Panel }}
          <div class="lu-preview">
            {{#if spells.previewItem}}
              <div class="lu-preview-header">
                <img src="{{spells.previewItem.img}}" alt="" class="lu-preview-img" />
                <h4>{{spells.previewItem.name}}</h4>
              </div>
              <div class="lu-spell-details">
                {{#if spells.previewItem.baseDamage}}<div class="lu-spell-detail"><strong>Base Damage:</strong> {{spells.previewItem.baseDamage}}</div>{{/if}}
                {{#if spells.previewItem.damageType}}
                  <div class="lu-spell-detail">
                    <strong>Damage Type:</strong>
                    {{#if spells.previewItem.damageTypeIcon}}<i class="{{spells.previewItem.damageTypeIcon}}"></i>{{/if}}
                    {{spells.previewItem.damageType}}
                  </div>
                {{/if}}
                {{#if spells.previewItem.manaCost}}<div class="lu-spell-detail"><strong>Mana Cost:</strong> {{spells.previewItem.manaCost}}</div>{{/if}}
                {{#if spells.previewItem.deliveryLabel}}<div class="lu-spell-detail"><strong>Delivery:</strong> {{spells.previewItem.deliveryLabel}}</div>{{/if}}
                {{#if spells.previewItem.range}}<div class="lu-spell-detail"><strong>Range:</strong> {{spells.previewItem.range}}</div>{{/if}}
              </div>
              <div class="lu-preview-body">{{{spells.previewItem.enrichedDescription}}}</div>
              {{#if (or spells.previewItem.crit spells.previewItem.duration)}}
                <div class="lu-spell-details lu-spell-details-bottom">
                  {{#if spells.previewItem.crit}}<div class="lu-spell-detail"><strong>Crit:</strong> {{spells.previewItem.crit}}</div>{{/if}}
                  {{#if spells.previewItem.duration}}<div class="lu-spell-detail"><strong>Duration:</strong> {{spells.previewItem.duration}}</div>{{/if}}
                </div>
              {{/if}}
              {{#if spells.previewItem.isOwned}}
                <span class="lu-owned-notice"><i class="fas fa-check"></i> Already Known</span>
              {{else if spells.previewItem.isChosen}}
                <span class="lu-owned-notice"><i class="fas fa-check"></i> Selected</span>
              {{else if spells.canAddMore}}
                <button type="button" class="lu-btn lu-btn-primary" data-action="addSpell" data-uuid="{{spells.previewItem.uuid}}">
                  <i class="fas fa-plus"></i> Learn Spell
                </button>
              {{/if}}
            {{else}}
              <p class="lu-placeholder">Select a spell to preview</p>
            {{/if}}
          </div>
        </div>
      </section>
    {{/if}}

  </div>

  {{! ─── Persistent Footer ─── }}
  <footer class="lu-footer">
    {{#if showLevelUpBtn}}
      <button type="button" class="lu-btn lu-btn-accent lu-btn-large" data-action="triggerLevelUp">
        <i class="fas fa-arrow-up"></i> Level Up!
      </button>
    {{/if}}
    {{#if showApplyBtn}}
      <button type="button" class="lu-btn lu-btn-accent lu-btn-large" data-action="applyLevelUp">
        <i class="fas fa-check-double"></i> Apply All Changes &amp; Close
      </button>
    {{/if}}
  </footer>
</div>
