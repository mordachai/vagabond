<form class="vagabond-builder flexcol" autocomplete="off">
    <nav class="builder-tabs flexrow">
        {{#each steps as |s|}}
        <a class="tab-item {{#if s.active}}active{{/if}} {{#if s.disabled}}disabled{{/if}}" data-step="{{s.id}}" data-action="goToStep">
            <span class="step-num">{{s.number}}-</span><span class="step-label">{{localize s.label}}</span>
        </a>
        {{/each}}
    </nav>

    <main class="builder-body">
        {{!-- LEFT COLUMN: Selection List (full height) --}}
        <aside class="selection-list-column">
            <div class="search-sticky">
                <input type="text" class="search-input" placeholder="Search..." autocomplete="off">
                <button type="button" class="search-clear" title="Clear search"><i class="fas fa-times"></i></button>
            </div>
            <div class="directory-list custom-scroll">
                {{#if (eq step 'stats')}}
                    {{#each statData.arrays}}
                        <li class="directory-item stat-array-item {{#if this.selected}}active{{/if}}"
                            data-id="{{this.id}}" data-action="selectOption">
                            <span class="array-label">{{this.id}}</span>
                            <span class="array-values">{{this.values}}</span>
                        </li>
                    {{/each}}
                {{else if isGearStep}}
                    <div class="budget-tracker {{#if budget.isOver}}bankrupt{{/if}}">
                        <span>Silver: <strong>{{budget.remaining}}</strong> / {{budget.total}}</span>
                    </div>
                    {{#each options as |group|}}
                    <details class="gear-accordion" {{#if group.isOpen}}open{{/if}}>
                        <summary class="category-header" data-category="{{group.id}}" data-action="toggleCategory">
                            <i class="fas fa-chevron-right"></i> {{group.label}}
                        </summary>
                        <ul class="item-list">
                            {{#each group.items as |opt|}}
                            <li class="directory-item gear-item flexrow {{#if opt.selected}}in-tray{{/if}} {{#if opt.previewing}}previewing{{/if}}" data-uuid="{{opt.uuid}}" data-action="selectOption">
                                <img src="{{opt.img}}" width="48" height="48">
                                <div class="item-info">
                                    <div class="name">{{opt.name}}</div>
                                    <div class="item-meta">
                                        <span class="item-slots"><i class="fas fa-box"></i> {{opt.system.baseSlots}}</span>
                                        <span class="item-cost"><i class="fas fa-coins"></i> {{#if opt.system.baseCost.gold}}{{opt.system.baseCost.gold}}g{{else}}{{opt.system.baseCost.silver}}s{{/if}}</span>
                                    </div>
                                </div>
                            </li>
                            {{/each}}
                        </ul>
                    </details>
                    {{/each}}
                {{else}}
                    {{#each options as |opt|}}
                    <li class="directory-item flexrow {{#if opt.selected}}in-tray{{/if}} {{#if opt.previewing}}previewing{{/if}}" data-uuid="{{opt.uuid}}" data-action="selectOption">
                        <img src="{{opt.img}}" width="32" height="32"><span class="name">{{opt.name}}</span>
                    </li>
                    {{/each}}
                {{/if}}
            </div>
        </aside>

        {{!-- RIGHT COLUMN: Decision, Tray, and Content Areas --}}
        <div class="right-column">
            <section class="decision-zone {{#unless hasChoices}}hidden{{/unless}}">
            {{!-- <header class="zone-header">{{localize "VAGABOND.CharBuilder.ProposedChoices"}}</header> --}}
            <div class="decision-tray">
                {{#if (eq step 'class')}}
                    <div class="skill-decision flexrow">
                        <div class="guaranteed-skills flexcol">
                            <strong>Obligatory Training:</strong>
                            {{#each classChoices.guaranteed}}<span class="skill-tag locked"><i class="fas fa-lock"></i> {{this.label}}</span>{{/each}}
                        </div>
                        {{#each classChoices.choices}}
                            <div class="pool-box">
                                <strong>Choose {{this.count}} from {{this.label}}:</strong>
                                <div class="pool-options">
                                    {{#each this.pool}}
                                        <label class="checkbox-label"><input type="checkbox" value="{{this.key}}" {{#if this.selected}}checked{{/if}} {{#if this.disabled}}disabled{{/if}} data-action="toggleSkill"> {{this.label}}</label>
                                    {{/each}}
                                </div>
                            </div>
                        {{/each}}
                    </div>
                {{/if}}

                {{#if (eq step 'stats')}}
                    {{!-- Stats to Pick and Drop --}}
                    <div class="available-pool">
                        <div class="flex-center-gap-12 flex-around w-100">
                            <h6>{{localize "VAGABOND.CharBuilder.AssignStats"}}</h6>
                            <button type="button" class="btn-reset-stats w-80" data-action="resetStats"><i class="fas fa-undo"></i> {{localize "VAGABOND.CharBuilder.Buttons.Reset"}}</button>
                        </div>
                        <div class="pool-values">
                            {{#each statData.unassigned}}
                            <button type="button" class="value-chip {{#if this.active}}active{{/if}}" data-index="{{this.index}}" data-value="{{this.value}}" data-action="pickValue">{{this.value}}</button>
                            {{/each}}
                        </div>
                        {{#if statData.unassigned}}
                        <div><i class="fa-light fa-chevrons-down" style="font-size: 2rem;"></i></div>
                        {{/if}}
                    </div>
                    <div class="stat-assigner">
                        {{#each statData.slots}}
                        {{!-- Char Stats --}}
                        <div class="stat-slot" data-stat="{{this.key}}">
                            <label>{{this.label}}</label>
                            <div class="hex-box {{#if this.value}}filled{{else}}empty{{/if}}">
                                {{#if this.value}}
                                    {{this.value}}
                                {{else}}
                                    ?
                                {{/if}}
                            </div>
                        </div>
                        {{/each}}
                    </div>
                {{/if}}
            </div>
        </section>
        {{!-- Tray Zone (visible on perks/spells/gear steps) --}}
        {{#if showTray}}
        <section class="tray-zone">
            <div class="tray-grid">
                {{!-- Instruction column (left side) --}}
                <div class="tray-sidebar">
                    <h3>{{localize "VAGABOND.CharBuilder.TrayTitle"}}</h3>
                    <p><small>{{localize "VAGABOND.CharBuilder.TrayInstructions"}}</small></p>
        
                    {{#if (eq step 'gear')}}
                        {{#if startingPackItems}}
                            <div class="pack-summary">
                                <strong>{{startingPackItems.packName}}</strong>
                                <p>{{localize "VAGABOND.CharBuilder.Budget"}}: {{startingPackItems.startingSilver}}s</p>
                            </div>
                        {{else}}
                            <div class="pack-summary">
                                <p>{{localize "VAGABOND.CharBuilder.Budget"}}: 300s</p>
                            </div>
                        {{/if}}
                    {{/if}}

                    {{#if (eq step 'spells')}}
                        {{#if spellLimit}}
                            <div class="pack-summary spell-limit-display">
                                <p><strong>Spells:</strong> {{currentSpellCount}}/{{spellLimit}}</p>
                                {{#if (gte currentSpellCount spellLimit)}}
                                    <p class="text-warning"><small>Maximum reached</small></p>
                                {{/if}}
                            </div>
                        {{/if}}
                    {{/if}}

                    <button type="button" class="btn-clear-tray" data-action="clearTray">
                        <i class="fas fa-trash"></i> {{localize "VAGABOND.CharBuilder.Buttons.ClearTray"}}
                    </button>
                </div>
        
                {{!-- Items grid (4 columns) --}}
                <div class="tray-items-grid">
                    {{#if (eq step 'perks')}}
                        {{#if trayData.isEmpty}}
                            <div class="tray-empty-message">
                                <i class="fas fa-arrow-left"></i>
                                <p>{{localize "VAGABOND.CharBuilder.TrayEmpty"}}</p>
                            </div>
                        {{else}}
                            {{#each trayData.perks as |item|}}
                                <div class="tray-item-compact {{#if item.isClassPerk}}from-class{{/if}}" data-uuid="{{item.uuid}}">
                                    <img src="{{item.img}}" alt="{{item.name}}" class="tray-img">
                                    <span class="tray-name">{{item.name}}{{#if item.isClassPerk}} <i class="fas fa-star" title="From Class"></i>{{/if}}</span>
                                    {{#if item.canDelete}}
                                        <button type="button" class="btn-remove" data-action="removeFromTray" data-uuid="{{item.uuid}}" title="Remove">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    {{else}}
                                        <i class="fas fa-lock" title="Granted by class" style="opacity: 0.5;"></i>
                                    {{/if}}
                                </div>
                            {{/each}}
                        {{/if}}
                    {{else if (eq step 'spells')}}
                        {{#if trayData.isEmpty}}
                            <div class="tray-empty-message">
                                <i class="fas fa-arrow-left"></i>
                                <p>{{localize "VAGABOND.CharBuilder.TrayEmpty"}}</p>
                            </div>
                        {{else}}
                            {{#each trayData.spells as |item|}}
                                <div class="tray-item-compact" data-uuid="{{item.uuid}}">
                                    <img src="{{item.img}}" alt="{{item.name}}" class="tray-img">
                                    <span class="tray-name">{{item.name}}</span>
                                    <button type="button" class="btn-remove" data-action="removeFromTray" data-uuid="{{item.uuid}}" title="Remove">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            {{/each}}
                        {{/if}}
                    {{else if (eq step 'gear')}}
                        {{#if trayData.isEmpty}}
                            <div class="tray-empty-message">
                                <i class="fas fa-arrow-left"></i>
                                <p>{{localize "VAGABOND.CharBuilder.TrayEmpty"}}</p>
                            </div>
                        {{else}}
                            {{#each trayData.gear as |item|}}
                                <div class="tray-item-compact gear-item {{#if item.fromStartingPack}}from-pack{{/if}}" data-uuid="{{item.uuid}}">
                                    <img src="{{item.img}}" alt="{{item.name}}" class="tray-img">
                                    <div class="tray-info">
                                        <span class="tray-name">{{item.name}}{{#if item.qty}} x{{item.qty}}{{/if}}</span>
                                        <span class="tray-meta">{{item.slots}} slots â€¢ {{item.costDisplay}}</span>
                                    </div>
                                    {{#if item.canDelete}}
                                        <button type="button" class="btn-remove" data-action="removeFromTray" data-uuid="{{item.uuid}}" title="Remove">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    {{/if}}
                                </div>
                            {{/each}}
                        {{/if}}
                    {{/if}}
                </div>
            </div>
        </section>
        {{/if}}

            <section class="content-zone {{#if useTripleColumn}}triple-column{{/if}}">
                <article class="selection-preview custom-scroll">
                {{#if instruction}}
                    <div class="step-instruction-overlay flexcol">
                        <i class="fas fa-info-circle"></i>
                        <p>{{instruction}}</p>
                    </div>
                {{/if}}

                {{#if (eq step 'stats')}}
                    {{#unless instruction}}
                    <div class="stats-preview-results">
                        <h3 class="preview-section-header">{{localize "VAGABOND.CharBuilder.DerivedStats"}}</h3>
                        <div class="preview-details-grid">
                            {{!-- Primary Derived Stats --}}
                            <div class="stat-box"><strong>HP:</strong> {{actor.system.health.max}}</div>
                            
                            {{!-- Spellcasting Stats (Only visible if Spellcaster) --}}
                            {{#if isSpellcaster}}
                                <div class="stat-box mana-box">
                                    <strong>{{localize "VAGABOND.Actor.Character.FIELDS.mana.max.label"}}:</strong> {{manaStats.max}}
                                </div>
                                <div class="stat-box mana-box">
                                    <strong>{{localize "VAGABOND.Actor.Character.FIELDS.mana.castingMax.label"}}:</strong> {{manaStats.castingMax}}
                                </div>
                            {{/if}}

                            <div class="stat-box"><strong>Luck Pool:</strong> {{actor.system.stats.luck.value}}</div>
                            <div class="stat-box"><strong>Inventory:</strong> {{actor.system.inventory.maxSlots}} Slots</div>
                            
                            {{!-- Movement Row --}}
                            <div class="grid-span-all movement-row">
                                <strong>Speed:</strong> {{actor.system.speed.base}}ft | 
                                <strong>Crawl:</strong> {{actor.system.speed.crawl}}ft | 
                                <strong>Travel:</strong> {{actor.system.speed.travel}} mi/day
                            </div>
                        </div>

                    </div>
                    {{!-- Saves Row --}}
                    <div class="stats-preview-results">
                            <h3 class="preview-section-header">{{localize "VAGABOND.Saves.savesTitle"}}</h3>
                                <div class="preview-details-grid">
                                <div class="stat-box"><strong>Reflex:</strong> {{actor.system.saves.reflex.difficulty}}</div>
                                <div class="stat-box"><strong>Endure:</strong> {{actor.system.saves.endure.difficulty}}</div>
                                <div class="stat-box"><strong>Will:</strong> {{actor.system.saves.will.difficulty}}</div>
                            </div>
                    </div>
                    {{/unless}}
                {{/if}}

                {{#if selectedItem}}
                    <div class="preview-header flexrow">
                        <img src="{{selectedItem.img}}" class="preview-img-main">
                        <div class="name-block">
                            <h2>{{selectedItem.name}}</h2>
                        </div>
                        {{#if (eq selectedItem.type "ancestry")}}
                        <div class="ancestry-info flexcol">
                            <div class="info-row"><strong>{{localize "VAGABOND.Actor.Character.FIELDS.attributes.beingType.label"}}:</strong> {{selectedItem.ancestryType}}</div>
                            <div class="info-row"><strong>{{localize "VAGABOND.Actor.Character.FIELDS.attributes.size.label"}}:</strong> {{capitalize selectedItem.size}}</div>
                        </div>
                        {{/if}}
                    </div>

                    <div class="preview-description">{{{selectedItem.enrichedDescription}}}</div>

                    {{!-- Add to Tray button --}}
                    {{#if showTray}}
                        <div class="preview-actions">
                            <button type="button" class="btn-add-to-tray" data-action="addToTray" data-uuid="{{selectedItem.uuid}}">
                                <i class="fas fa-plus"></i> {{localize "VAGABOND.CharBuilder.Buttons.AddToTray"}}
                            </button>
                        </div>
                    {{/if}}

                    {{#if (eq selectedItem.type "ancestry")}}
                        <div class="traits-container">
                            <h3 class="preview-section-header">{{localize "VAGABOND.CharBuilder.Traits"}}</h3>
                            {{#each selectedItem.traits}}
                                <div class="trait-item">
                                    <strong>{{this.name}}:</strong> {{{this.description}}}
                                </div>
                            {{/each}}
                        </div>
                    {{/if}}

                    {{!-- Starting Pack Contents Display --}}
                    {{#if (eq step 'starting-packs')}}
                        {{#if startingPackItems}}
                            <div class="starting-pack-contents">
                                <h3 class="preview-section-header">{{localize "VAGABOND.CharBuilder.PackContents"}}</h3>
                                <div class="pack-budget-info">
                                    <strong>{{localize "VAGABOND.CharBuilder.Budget"}}:</strong> {{startingPackItems.startingSilver}}s
                                </div>
                                <div class="pack-items-list">
                                    {{#each startingPackItems.items as |item|}}
                                        <div class="pack-item-row">
                                            <img src="{{item.img}}" alt="{{item.name}}" class="pack-item-img">
                                            <div class="pack-item-info">
                                                <span class="pack-item-name">{{item.name}}</span>
                                                <span class="pack-item-qty">x{{item.qty}}</span>
                                            </div>
                                            <div class="pack-item-meta">
                                                <span class="pack-item-slots">{{item.slots}} slots</span>
                                                <span class="pack-item-cost">{{item.costDisplay}}</span>
                                            </div>
                                        </div>
                                    {{/each}}
                                </div>
                                <div class="preview-actions">
                                    <button type="button" class="btn-remove-pack" data-action="removeStartingPack">
                                        <i class="fas fa-times-circle"></i> {{localize "VAGABOND.CharBuilder.Buttons.RemovePack"}}
                                    </button>
                                </div>
                            </div>
                        {{/if}}
                    {{/if}}

                    {{!-- Equipment Details --}}
                    {{#if (eq selectedItem.type "equipment")}}
                        <div class="equipment-details">
                            {{!-- WEAPONS --}}
                            {{#if (eq selectedItem.displayStats.subType "weapons")}}
                                <h3 class="preview-section-header">Weapon Details</h3>
                                <div class="preview-details-grid">
                                    {{#if selectedItem.displayStats.weaponSkill}}
                                        <div><strong>Skill:</strong> {{selectedItem.displayStats.weaponSkill}}</div>
                                    {{/if}}
                                    {{#if selectedItem.displayStats.range}}
                                        <div><strong>Range:</strong> {{selectedItem.displayStats.range}}</div>
                                    {{/if}}
                                    {{#if selectedItem.displayStats.grip}}
                                        <div><strong>Grip:</strong> {{selectedItem.displayStats.grip}}</div>
                                    {{/if}}
                                    {{#if selectedItem.displayStats.damage1h}}
                                        <div><strong>1H Damage:</strong> {{selectedItem.displayStats.damage1h}}</div>
                                    {{/if}}
                                    {{#if selectedItem.displayStats.damage2h}}
                                        <div><strong>2H Damage:</strong> {{selectedItem.displayStats.damage2h}}</div>
                                    {{/if}}
                                    {{#if selectedItem.displayStats.damageType}}
                                        <div class="damage-type-row">
                                            <strong>Damage Type:</strong>
                                            {{#if selectedItem.displayStats.damageTypeIcon}}
                                                <i class="{{selectedItem.displayStats.damageTypeIcon}}"></i>
                                            {{/if}}
                                            {{selectedItem.displayStats.damageType}}
                                        </div>
                                    {{/if}}
                                    <div><strong>Slots:</strong> {{selectedItem.displayStats.slots}}</div>
                                    <div><strong>Cost:</strong>
                                        {{#if selectedItem.displayStats.cost.gold}}{{selectedItem.displayStats.cost.gold}}g {{/if}}
                                        {{#if selectedItem.displayStats.cost.silver}}{{selectedItem.displayStats.cost.silver}}s {{/if}}
                                        {{#if selectedItem.displayStats.cost.copper}}{{selectedItem.displayStats.cost.copper}}c{{/if}}
                                    </div>
                                </div>
                                {{#if selectedItem.displayStats.propertiesWithHints}}
                                    <div class="weapon-properties">
                                        <h4>Properties</h4>
                                        {{#each selectedItem.displayStats.propertiesWithHints}}
                                            <div class="property-item" title="{{this.hint}}">
                                                <strong>{{this.name}}:</strong> <em>{{this.hint}}</em>
                                            </div>
                                        {{/each}}
                                    </div>
                                {{/if}}
                            {{/if}}

                            {{!-- ARMOR --}}
                            {{#if (eq selectedItem.displayStats.subType "armor")}}
                                <h3 class="preview-section-header">Armor Details</h3>
                                <div class="preview-details-grid">
                                    {{#if selectedItem.displayStats.armorRating}}
                                        <div><strong>Armor Rating:</strong> {{selectedItem.displayStats.armorRating}}</div>
                                    {{/if}}
                                    {{#if selectedItem.displayStats.mightRequirement}}
                                        <div><strong>Might Requirement:</strong> {{selectedItem.displayStats.mightRequirement}}</div>
                                    {{/if}}
                                    {{#if selectedItem.displayStats.armorType}}
                                        <div><strong>Type:</strong> {{selectedItem.displayStats.armorType}}</div>
                                    {{/if}}
                                    <div><strong>Slots:</strong> {{selectedItem.displayStats.slots}}</div>
                                    <div><strong>Cost:</strong>
                                        {{#if selectedItem.displayStats.cost.gold}}{{selectedItem.displayStats.cost.gold}}g {{/if}}
                                        {{#if selectedItem.displayStats.cost.silver}}{{selectedItem.displayStats.cost.silver}}s {{/if}}
                                        {{#if selectedItem.displayStats.cost.copper}}{{selectedItem.displayStats.cost.copper}}c{{/if}}
                                    </div>
                                </div>
                            {{/if}}

                            {{!-- ALCHEMICALS --}}
                            {{#if (eq selectedItem.displayStats.subType "alchemical-items")}}
                                <h3 class="preview-section-header">Alchemical Details</h3>
                                <div class="preview-details-grid">
                                    {{#if selectedItem.displayStats.alchemicalType}}
                                        <div><strong>Type:</strong> {{selectedItem.displayStats.alchemicalType}}</div>
                                    {{/if}}
                                    {{#if selectedItem.displayStats.damage}}
                                        <div><strong>Damage:</strong> {{selectedItem.displayStats.damage}}</div>
                                    {{/if}}
                                    {{#if selectedItem.displayStats.damageType}}
                                        <div class="damage-type-row">
                                            <strong>Damage Type:</strong>
                                            {{#if selectedItem.displayStats.damageTypeIcon}}
                                                <i class="{{selectedItem.displayStats.damageTypeIcon}}"></i>
                                            {{/if}}
                                            {{selectedItem.displayStats.damageType}}
                                        </div>
                                    {{/if}}
                                    <div><strong>Slots:</strong> {{selectedItem.displayStats.slots}}</div>
                                    <div><strong>Cost:</strong>
                                        {{#if selectedItem.displayStats.cost.gold}}{{selectedItem.displayStats.cost.gold}}g {{/if}}
                                        {{#if selectedItem.displayStats.cost.silver}}{{selectedItem.displayStats.cost.silver}}s {{/if}}
                                        {{#if selectedItem.displayStats.cost.copper}}{{selectedItem.displayStats.cost.copper}}c{{/if}}
                                    </div>
                                </div>
                            {{/if}}

                            {{!-- RELICS --}}
                            {{#if (eq selectedItem.displayStats.subType "relics")}}
                                <h3 class="preview-section-header">Relic Details</h3>
                                {{#if selectedItem.displayStats.lore}}
                                    <div class="relic-lore">
                                        <h4>Lore</h4>
                                        <p>{{{selectedItem.displayStats.enrichedLore}}}</p>
                                    </div>
                                {{/if}}
                                <div class="preview-details-grid">
                                    <div><strong>Slots:</strong> {{selectedItem.displayStats.slots}}</div>
                                    <div><strong>Cost:</strong>
                                        {{#if selectedItem.displayStats.cost.gold}}{{selectedItem.displayStats.cost.gold}}g {{/if}}
                                        {{#if selectedItem.displayStats.cost.silver}}{{selectedItem.displayStats.cost.silver}}s {{/if}}
                                        {{#if selectedItem.displayStats.cost.copper}}{{selectedItem.displayStats.cost.copper}}c{{/if}}
                                    </div>
                                </div>
                            {{/if}}

                            {{!-- GEAR (generic) --}}
                            {{#if (eq selectedItem.displayStats.subType "gear")}}
                                <h3 class="preview-section-header">Gear Details</h3>
                                <div class="preview-details-grid">
                                    <div><strong>Slots:</strong> {{selectedItem.displayStats.slots}}</div>
                                    <div><strong>Cost:</strong>
                                        {{#if selectedItem.displayStats.cost.gold}}{{selectedItem.displayStats.cost.gold}}g {{/if}}
                                        {{#if selectedItem.displayStats.cost.silver}}{{selectedItem.displayStats.cost.silver}}s {{/if}}
                                        {{#if selectedItem.displayStats.cost.copper}}{{selectedItem.displayStats.cost.copper}}c{{/if}}
                                    </div>
                                </div>
                            {{/if}}
                        </div>
                    {{/if}}
                {{/if}}
            </article>

            {{#if useTripleColumn}}
            <aside class="reference-column custom-scroll">
                {{!-- COLUMN 3: CLASS DATA --}}
                {{#if (eq step 'class')}}
                    {{#if classPreviewData}}
                        <div class="class-summary-box">
                            <h4 class="ref-header">{{localize "VAGABOND.CharBuilder.ClassDetails"}}</h4>
                            
                            {{!-- 2-Column Grid for Class Info --}}
                            <div class="class-details-grid">
                                <div class="detail-item">
                                    <span class="label">Spellcaster:</span> 
                                    <span class="value">{{localize (concat "VAGABOND.Terms." classPreviewData.isSpellcaster)}}</span>
                                </div>
                                {{#if (eq classPreviewData.isSpellcaster "Yes")}}
                                    <div class="detail-item">
                                        <span class="label">Skill:</span>
                                        <span class="value">
                                        {{#if (eq classPreviewData.manaSkill "None")}}
                                            {{localize "VAGABOND.Terms.None"}}
                                        {{else}}
                                            {{localize (concat "VAGABOND.Skills." classPreviewData.manaSkill)}}
                                        {{/if}}
                                        </span>
                                    </div>
                                {{/if}}
                            </div>

                            <h4 class="ref-header">{{localize "VAGABOND.CharBuilder.Levels"}}</h4>
                            {{#each classPreviewData.levelGroups}}
                                <details class="level-accordion" {{#if this.isOpen}}open{{/if}}>
                                    <summary class="level-header">
                                        <i class="fas fa-chevron-right"></i>
                                        <span>Level {{this.level}}</span>
                                    </summary>
                                    <div class="level-content">
                                        {{#if (eq @root.classPreviewData.isSpellcaster "Yes")}}
                                            <div class="level-traits">
                                                <div class="trait-badge">
                                                    <strong>Mana:</strong> <span>{{this.maxMana}}</span>
                                                </div>
                                                {{#if this.spells}}
                                                    <div class="trait-badge">
                                                        <strong>Spells:</strong> <span>{{this.spells}}</span>
                                                    </div>
                                                {{/if}}
                                            </div>
                                        {{/if}}
                                        {{#each this.features}}
                                            <div class="ref-entry">
                                                <strong>{{this.name}}:</strong> {{{this.enrichedDescription}}}
                                            </div>
                                        {{/each}}
                                    </div>
                                </details>
                            {{/each}}
                        </div>
                    {{/if}}
                {{/if}}

                {{!-- Origin Refs (Ancestry Traits/Class Features for later steps) --}}
                {{#if (or (eq step 'perks') (eq step 'spells'))}}
                    {{#if originRefs.ancestry}}
                        <h4 class="ref-header">Traits ({{originRefs.ancestry.name}})</h4>
                        {{#each originRefs.ancestry.traits}}
                            <div class="ref-entry"><strong>{{this.name}}: </strong> {{{this.description}}}</div>
                        {{/each}}
                    {{/if}}
                    {{#if originRefs.class}}
                        <h4 class="ref-header">Features ({{originRefs.class.name}})</h4>
                        {{#each originRefs.class.features}}
                            <div class="ref-entry"><strong>{{this.name}}: </strong>{{{this.enrichedDescription}}}</div>
                        {{/each}}
                    {{/if}}
                {{/if}}
            </aside>
            {{/if}}
            </section>
        </div>
    </main>

    <footer class="builder-footer flexrow">
        <div class="footer-left flexrow">
            <button type="button" class="btn-dismiss" data-action="dismissBuilder" data-tooltip="Dismiss builder and use normal character sheet">
                <i class="fas fa-times-circle"></i> Dismiss
            </button>
            {{#if showFullRandomButton}}
                <button type="button" class="btn-full-random" data-action="randomizeFullCharacter">
                    <i class="fas fa-bolt"></i> Full Random Character
                </button>
            {{/if}}
            {{#if showRandomButton}}
                <button type="button" class="btn-random" data-action="randomize">
                    <i class="fas fa-dice"></i> Random
                </button>
            {{/if}}
        </div>
        <div class="footer-nav flexrow">
            <button type="button" class="btn-prev" data-action="prev">Previous</button>
            <button type="button" class="btn-next" data-action="next" {{#unless canAdvance}}disabled{{/unless}}>Next</button>
            <button type="button" class="btn-finish" data-action="finish" {{#unless canFinish}}disabled{{/unless}}>Finish</button>
        </div>
    </footer>
</form>
