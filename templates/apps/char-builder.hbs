<form class="vagabond-builder flexcol" autocomplete="off">
    <nav class="builder-tabs flexrow">
        {{#each steps as |s|}}
        <a class="tab-item {{#if s.active}}active{{/if}} {{#if s.disabled}}disabled{{/if}}" data-step="{{s.id}}" data-action="goToStep">
            <span class="step-num">{{s.number}}-</span><span class="step-label">{{localize s.label}}</span>
        </a>
        {{/each}}
    </nav>

    <main class="builder-body flexcol">
        <section class="decision-zone {{#unless hasChoices}}hidden{{/unless}}">
            <header class="zone-header">{{localize "VAGABOND.CharBuilder.ProposedChoices"}}</header>
            <div class="decision-tray flexrow">
                {{#if (eq step 'class')}}
                    <div class="skill-decision flexrow">
                        <div class="guaranteed-skills flexcol">
                            <strong>Obligatory Training:</strong>
                            {{#each classChoices.guaranteed}}<span class="skill-tag locked"><i class="fas fa-lock"></i> {{this.label}}</span>{{/each}}
                        </div>
                        {{#each classChoices.choices}}
                            <div class="pool-box">
                                <strong>Choose {{this.count}} from {{this.label}}:</strong>
                                <div class="pool-options">
                                    {{#each this.pool}}
                                        <label class="checkbox-label"><input type="checkbox" value="{{this.key}}" {{#if this.selected}}checked{{/if}} {{#if this.disabled}}disabled{{/if}} data-action="toggleSkill"> {{this.label}}</label>
                                    {{/each}}
                                </div>
                            </div>
                        {{/each}}
                    </div>
                {{/if}}

                {{#if (eq step 'stats')}}
                    {{!-- Stats to Pick and Drop --}}
                    <div class="available-pool">
                        <div>
                            <h6>{{localize "VAGABOND.CharBuilder.AssignStats"}}</h6>
                            <button type="button" class="btn-reset-stats" data-action="resetStats"><i class="fas fa-undo"></i> {{localize "VAGABOND.CharBuilder.Buttons.Reset"}}</button>
                        </div>
                        <div class="pool-values">
                            {{#each statData.unassigned}}
                            <button type="button" class="value-chip {{#if this.active}}active{{/if}}" data-index="{{this.index}}" data-value="{{this.value}}" data-action="pickValue">{{this.value}}</button>
                            {{/each}}
                        </div>
                        <div><i class="fa-light fa-chevrons-right" style="font-size: 2rem;"></i></div>
                    </div>
                    <div class="stat-assigner">
                        {{#each statData.slots}}
                        {{!-- Char Stats --}}
                        <div class="stat-slot" data-stat="{{this.key}}">
                            <label>{{this.label}}</label>
                            <div class="hex-box {{#if this.value}}filled{{else}}empty{{/if}}">
                                {{#if this.value}}
                                    {{this.value}}
                                {{else}}
                                    ?
                                {{/if}}
                            </div>
                        </div>
                        {{/each}}
                    </div>
                {{/if}}
            </div>
        </section>

        <section class="selection-zone {{#if useTripleColumn}}triple-column{{/if}}">
            <aside class="selection-list flexcol">
                <div class="search-sticky"><input type="text" placeholder="Search..." data-action="filterList"></div>
                <div class="directory-list custom-scroll">
                    {{#if (eq step 'stats')}}
                        {{#each statData.arrays}}
                            <li class="directory-item stat-array-item {{#if this.selected}}active{{/if}}" 
                                data-id="{{this.id}}" data-action="selectOption">
                                <span class="array-label">{{this.id}}</span>
                                <span class="array-values">{{this.values}}</span>
                            </li>
                        {{/each}}
                    {{else if isGearStep}}
                        <div class="budget-tracker {{#if budget.isOver}}bankrupt{{/if}}">
                            <span>Silver: <strong>{{budget.remaining}}</strong> / {{budget.total}}</span>
                        </div>
                        {{#each options as |group|}}
                        <details class="gear-accordion" {{#if group.isOpen}}open{{/if}}>
                            <summary class="category-header" data-category="{{group.id}}" data-action="toggleCategory">
                                <i class="fas fa-chevron-right"></i> {{group.label}}
                            </summary>
                            <ul class="item-list">
                                {{#each group.items as |opt|}}
                                <li class="directory-item flexrow {{#if opt.selected}}active{{/if}}" data-uuid="{{opt.uuid}}" data-action="selectOption">
                                    <img src="{{opt.img}}" width="32" height="32"><span class="name">{{opt.name}}</span>
                                </li>
                                {{/each}}
                            </ul>
                        </details>
                        {{/each}}
                    {{else}}
                        {{#each options as |opt|}}
                        <li class="directory-item flexrow {{#if opt.selected}}active{{/if}}" data-uuid="{{opt.uuid}}" data-action="selectOption">
                            <img src="{{opt.img}}" width="32" height="32"><span class="name">{{opt.name}}</span>
                        </li>
                        {{/each}}
                    {{/if}}
                </div>
            </aside>

            <article class="selection-preview custom-scroll">
                {{#if instruction}}
                    <div class="step-instruction-overlay flexcol">
                        <i class="fas fa-info-circle"></i>
                        <p>{{instruction}}</p>
                    </div>
                {{/if}}

                {{#if (eq step 'stats')}}
                    {{#unless instruction}}
                    <div class="stats-preview-results">
                        <h3 class="preview-section-header">{{localize "VAGABOND.CharBuilder.DerivedStats"}}</h3>
                        <div class="preview-details-grid">
                            <div class="stat-box"><strong>HP:</strong> {{actor.system.health.max}}</div>
                            <div class="stat-box"><strong>Luck Pool:</strong> {{actor.system.stats.luck.value}}</div>
                            <div class="stat-box"><strong>Inventory:</strong> {{actor.system.inventory.maxSlots}} Slots</div>
                            
                            <div class="grid-span-all movement-row">
                                <strong>Speed:</strong> {{actor.system.speed.base}}ft | 
                                <strong>Crawl:</strong> {{actor.system.speed.crawl}}ft | 
                                <strong>Travel:</strong> {{actor.system.speed.travel}} mi/day
                            </div>

                            <div class="grid-span-all saves-header">Saves</div>
                            <div class="stat-box"><strong>Reflex:</strong> {{actor.system.saves.reflex.difficulty}}</div>
                            <div class="stat-box"><strong>Endure:</strong> {{actor.system.saves.endure.difficulty}}</div>
                            <div class="stat-box"><strong>Will:</strong> {{actor.system.saves.will.difficulty}}</div>
                        </div>
                    </div>
                    {{/unless}}
                {{/if}}

                {{#if selectedItem}}
                    <div class="preview-header flexrow">
                        <img src="{{selectedItem.img}}" class="preview-img-main">
                        <div class="name-block flexcol">
                            <h2>{{selectedItem.name}}</h2>
                        </div>
                    </div>

                    <div class="preview-description">{{{selectedItem.enrichedDescription}}}</div>

                    {{#if (eq selectedItem.type "ancestry")}}
                        <div class="traits-container">
                            <h3 class="preview-section-header">{{localize "VAGABOND.CharBuilder.Traits"}}</h3>
                            {{#each selectedItem.traits}}
                                <div class="trait-item">
                                    <strong>{{this.name}}:</strong> {{{this.description}}}
                                </div>
                            {{/each}}
                        </div>
                    {{/if}}

                    {{!-- Gear/Weapon/Armor Grid remains here --}}
                    <div class="preview-details-grid">
                        {{#if (eq selectedItem.displayStats.subType "weapon")}}
                            <div><strong>1H Damage:</strong> {{selectedItem.displayStats.damage1h}}</div>
                            <div><strong>2H Damage:</strong> {{selectedItem.displayStats.damage2h}}</div>
                            <div><strong>Type:</strong> {{selectedItem.displayStats.damageType}}</div>
                            <div><strong>Range:</strong> {{selectedItem.displayStats.range}}</div>
                            <div><strong>Grip:</strong> {{selectedItem.displayStats.grip}}</div>
                            <div><strong>Skill:</strong> {{selectedItem.displayStats.skill}}</div>
                            <div><strong>Slots:</strong> {{selectedItem.displayStats.slots}}</div>
                            <div><strong>Cost:</strong> {{selectedItem.displayStats.costLabel}}</div>
                        {{/if}}
                        {{!-- ... (Armor/Alchemical/Gear blocks same as before) --}}
                    </div>
                {{/if}}
            </article>

            {{#if useTripleColumn}}
            <aside class="reference-column custom-scroll">
                {{!-- COLUMN 3: CLASS DATA --}}
                {{#if (eq step 'class')}}
                    {{#if classPreviewData}}
                        <div class="class-summary-box">
                            <h4 class="ref-header">{{localize "VAGABOND.CharBuilder.ClassDetails"}}</h4>
                            
                            {{!-- 2-Column Grid for Class Info --}}
                            <div class="class-details-grid">
                                <div class="detail-item">
                                    <span class="label">Spellcaster:</span> 
                                    <span class="value">{{localize (concat "VAGABOND.Terms." classPreviewData.isSpellcaster)}}</span>
                                </div>
                                {{#if (eq classPreviewData.isSpellcaster "Yes")}}
                                    <div class="detail-item">
                                        <span class="label">Skill:</span> 
                                        <span class="value">
                                        {{#if (eq classPreviewData.manaSkill "None")}}
                                            {{localize "VAGABOND.Terms.None"}}
                                        {{else}}
                                            {{localize (concat "VAGABOND.Skills." classPreviewData.manaSkill)}}
                                        {{/if}}
                                        </span>
                                    </div>  
                                {{/if}}
                            </div>

                            <h4 class="ref-header">{{localize "VAGABOND.CharBuilder.Levels"}}</h4>
                            {{#each classPreviewData.levelGroups}}
                                <details class="level-accordion" {{#if this.isOpen}}open{{/if}}>
                                    <summary class="level-header">
                                        <i class="fas fa-chevron-right"></i> 
                                        <span>Level {{this.level}}</span>
                                    </summary>
                                    <div class="level-content">
                                        {{#each this.features}}
                                            <div class="ref-entry">
                                                <strong>{{this.name}}:</strong> {{{this.description}}}
                                            </div>
                                        {{/each}}
                                    </div>
                                </details>
                            {{/each}}
                        </div>
                    {{/if}}
                {{/if}}

                {{!-- Origin Refs (Ancestry Traits/Class Features for later steps) --}}
                {{#if (or (eq step 'perks') (eq step 'spells'))}}
                    {{#if originRefs.ancestry}}
                        <h4 class="ref-header">Traits ({{originRefs.ancestry.name}})</h4>
                        {{#each originRefs.ancestry.traits}}
                            <div class="ref-entry"><strong>{{this.name}}: </strong> {{{this.description}}}</div>
                        {{/each}}
                    {{/if}}
                    {{#if originRefs.class}}
                        <h4 class="ref-header">Features ({{originRefs.class.name}})</h4>
                        {{#each originRefs.class.features}}
                            <div class="ref-entry"><strong>{{this.name}}: </strong>{{{this.description}}}</div>
                        {{/each}}
                    {{/if}}
                {{/if}}
            </aside>
            {{/if}}
        </section>
    </main>

    <footer class="builder-footer flexrow">
        <button type="button" class="btn-random" data-action="randomize"><i class="fas fa-dice"></i> Random</button>
        <div class="footer-nav flexrow"><button type="button" class="btn-prev" data-action="prev">Previous</button><button type="button" class="btn-next" data-action="next">Next</button><button type="submit" class="btn-finish">Finish</button></div>
    </footer>
</form>