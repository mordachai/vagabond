<article class="selection-preview custom-scroll">
    {{#if instruction}}
        <div class="step-instruction-overlay flexcol">
            <i class="fas fa-info-circle"></i>
            <p>{{instruction}}</p>
        </div>
    {{/if}}

    {{#if (eq step 'stats')}}
        {{#unless instruction}}
        <div class="stats-preview-results">
            <h3 class="preview-section-header">{{localize "VAGABOND.CharBuilder.DerivedStats"}}</h3>
            <div class="preview-skills-grid stats-grid">
                {{!-- Primary Derived Stats --}}
                <div class="skill-item">
                    <span class="skill-name">{{statData.derived.hp.label}}</span>
                    <span class="skill-dots"></span>
                    <span class="skill-value">{{statData.derived.hp.value}}</span>
                </div>

                {{!-- Spellcasting Stats (Only visible if Spellcaster) --}}
                {{#if statData.derived.isSpellcaster}}
                    <div class="skill-item">
                        <span class="skill-name">{{statData.derived.manaMax.label}}</span>
                        <span class="skill-dots"></span>
                        <span class="skill-value">{{statData.derived.manaMax.value}}</span>
                    </div>
                    <div class="skill-item">
                        <span class="skill-name">{{statData.derived.manaCast.label}}</span>
                        <span class="skill-dots"></span>
                        <span class="skill-value">{{statData.derived.manaCast.value}}</span>
                    </div>
                {{/if}}

                <div class="skill-item">
                    <span class="skill-name">{{statData.derived.inventory.label}}</span>
                    <span class="skill-dots"></span>
                    <span class="skill-value">{{statData.derived.inventory.value}}</span>
                </div>
                <div class="skill-item">
                    <span class="skill-name">{{statData.derived.luck.label}}</span>
                    <span class="skill-dots"></span>
                    <span class="skill-value">{{statData.derived.luck.value}}</span>
                </div>

                <div class="skill-item">
                    <span class="skill-name">{{statData.derived.speed.label}}</span>
                    <span class="skill-dots"></span>
                    <span class="skill-value">{{statData.derived.speed.value}}</span>
                </div>
            </div>
        </div>

        {{!-- Saves --}}
        <div class="stats-preview-results">
            <h3 class="preview-section-header">{{localize "VAGABOND.Saves.savesTitle"}}</h3>
            <div class="preview-skills-grid saves-grid grid-3col">
                {{#each statData.derived.saves}}
                    <div class="skill-item" title="{{this.tooltip}}">
                        <span class="skill-name">{{this.label}}</span>
                        <span class="skill-dots"></span>
                        <span class="skill-value">{{this.value}}</span>
                    </div>
                {{/each}}
            </div>
        </div>

        {{!-- Skills (4 Columns) --}}
        <div class="stats-preview-results">
            <h3 class="preview-section-header">{{localize "VAGABOND.UI.Sections.Skills"}}</h3>
            <div class="preview-skills-grid skills-4-col">
                {{#each statData.derived.skills}}
                    <div class="skill-item {{#if this.trained}}trained{{/if}}" title="{{this.tooltip}}">
                        <span class="skill-name">
                            {{#if this.trained}}<strong>{{/if}}
                            {{this.label}}{{#if this.statAbbr}} <span class="stat-abbr">[{{this.statAbbr}}]</span>{{/if}}
                            {{#if this.trained}}</strong>{{/if}}
                        </span>
                        <span class="skill-dots"></span>
                        <span class="skill-value">{{this.value}}</span>
                    </div>
                {{/each}}
            </div>
        </div>

        {{!-- Weapon Skills (4 Columns) --}}
        <div class="stats-preview-results">
            <h3 class="preview-section-header">{{localize "VAGABOND.UI.Labels.WeaponSkills"}}</h3>
            <div class="preview-skills-grid weapon-skills-4-col">
                {{#each statData.derived.weaponSkills}}
                    <div class="skill-item {{#if this.trained}}trained{{/if}}" title="{{this.tooltip}}">
                        <span class="skill-name">
                            {{#if this.trained}}<strong>{{/if}}
                            {{this.label}}{{#if this.statAbbr}} <span class="stat-abbr">[{{this.statAbbr}}]</span>{{/if}}
                            {{#if this.trained}}</strong>{{/if}}
                        </span>
                        <span class="skill-dots"></span>
                        <span class="skill-value">{{this.value}}</span>
                    </div>
                {{/each}}
            </div>
        </div>
        {{/unless}}
    {{/if}}

    {{#if selectedItem}}
        <div class="preview-header flexrow">
            <img src="{{selectedItem.img}}" class="preview-img-main">
            <div class="name-block">
                <h2>{{selectedItem.name}}</h2>
                {{#if (eq selectedItem.type "spell")}}
                    {{#if selectedItem.displayStats.damageTypeLabel}}
                        <div class="spell-damage-type">
                            {{#if selectedItem.displayStats.damageTypeIcon}}<i class="{{selectedItem.displayStats.damageTypeIcon}}"></i>{{/if}}
                            <span>{{selectedItem.displayStats.damageTypeLabel}}</span>
                        </div>
                    {{/if}}
                {{/if}}
            </div>
        </div>

        {{!-- Perk Prerequisites Display --}}
        {{#if (eq selectedItem.type "perk")}}
            {{#if selectedItem.hasPrerequisites}}
                <div class="perk-prerequisites-compact">
                    <h4 class="prereq-header">
                        {{localize "VAGABOND.Item.Perk.FIELDS.prerequisites.label"}}
                        {{#if selectedItem.prerequisitesMet}}
                            <i class="fas fa-check prereq-met-icon"></i>
                        {{else}}
                            <i class="fas fa-times prereq-not-met-icon"></i>
                        {{/if}}
                    </h4>
                    <div class="prereq-line">
                        {{{selectedItem.prerequisitesCompactHTML}}}
                    </div>
                </div>
            {{/if}}
        {{/if}}

        <div class="preview-description">{{{selectedItem.enrichedDescription}}}</div>

        {{#if (eq selectedItem.type "spell")}}
            {{#if selectedItem.displayStats}}
                <div class="spell-details">
                    <h3 class="preview-section-header">{{localize "VAGABOND.UI.Labels.SpellDetails"}}</h3>
                    <div class="preview-details-grid">
                        {{#if selectedItem.displayStats.baseDamage}}
                            <div><strong>Base Damage:</strong> {{selectedItem.displayStats.baseDamage}}</div>
                        {{/if}}
                        {{#if selectedItem.displayStats.damageType}}
                            <div class="damage-type-row">
                                <strong>Damage Type:</strong>
                                {{#if selectedItem.displayStats.damageTypeIcon}}
                                    <i class="{{selectedItem.displayStats.damageTypeIcon}}"></i>
                                {{/if}}
                                {{selectedItem.displayStats.damageType}}
                            </div>
                        {{/if}}
                        {{#if selectedItem.displayStats.crit}}
                            <div><strong>Crit:</strong> {{selectedItem.displayStats.crit}}</div>
                        {{/if}}
                        {{#if selectedItem.displayStats.deliveryLabel}}
                            <div><strong>Delivery:</strong> {{selectedItem.displayStats.deliveryLabel}}</div>
                        {{/if}}
                        {{#if selectedItem.displayStats.manaCost}}
                            <div><strong>Mana Cost:</strong> {{selectedItem.displayStats.manaCost}}</div>
                        {{/if}}
                        {{#if selectedItem.displayStats.range}}
                            <div><strong>Range:</strong> {{selectedItem.displayStats.range}}</div>
                        {{/if}}
                        {{#if selectedItem.displayStats.duration}}
                            <div><strong>Duration:</strong> {{selectedItem.displayStats.duration}}</div>
                        {{/if}}
                        {{#if selectedItem.displayStats.areaOfEffect}}
                            <div><strong>Area of Effect:</strong> {{selectedItem.displayStats.areaOfEffect}}</div>
                        {{/if}}
                        {{#if selectedItem.displayStats.condition}}
                            <div><strong>Condition:</strong> {{selectedItem.displayStats.condition}}</div>
                        {{/if}}
                    </div>
                </div>
            {{/if}}
        {{/if}}

        {{!-- Add to Tray button --}}
        {{#if showTray}}
            <div class="preview-actions">
                <button type="button" class="btn-add-to-tray" data-action="addToTray" data-uuid="{{selectedItem.uuid}}">
                    <i class="fas fa-plus"></i> {{localize "VAGABOND.CharBuilder.Buttons.AddToTray"}}
                </button>
            </div>
        {{/if}}

        {{!-- Starting Pack Contents Display --}}
        {{#if (eq step 'starting-packs')}}
            {{#if startingPackItems}}
                <div class="starting-pack-contents">
                    <h3 class="preview-section-header">{{localize "VAGABOND.CharBuilder.PackContents"}}</h3>
                    <div class="pack-budget-info">
                        <strong>{{localize "VAGABOND.CharBuilder.Budget"}}:</strong> {{startingPackItems.startingSilver}}s
                    </div>
                    <div class="pack-items-list">
                        {{#each startingPackItems.items as |item|}}
                            <div class="pack-item-row">
                                <img src="{{item.img}}" alt="{{item.name}}" class="pack-item-img">
                                <div class="pack-item-info">
                                    <span class="pack-item-name">{{item.name}}</span>
                                    <span class="pack-item-qty">x{{item.qty}}</span>
                                </div>
                                <div class="pack-item-meta">
                                    <span class="pack-item-slots">{{item.slots}} slots</span>
                                    <span class="pack-item-cost">{{item.costDisplay}}</span>
                                </div>
                            </div>
                        {{/each}}
                    </div>
                    {{#if hasSelection}}
                    <div class="preview-actions">
                        <button type="button" class="btn-remove-pack" data-action="removeStartingPack">
                            <i class="fas fa-times-circle"></i> {{localize "VAGABOND.CharBuilder.Buttons.RemovePack"}}
                        </button>
                    </div>
                    {{/if}}
                </div>
            {{/if}}
        {{/if}}

        {{!-- Equipment Details --}}
        {{#if (eq selectedItem.type "equipment")}}
            <div class="equipment-details">
                {{!-- WEAPONS --}}
                {{#if (eq selectedItem.displayStats.subType "weapon")}}
                    <h3 class="preview-section-header">{{localize "VAGABOND.UI.Labels.WeaponDetails"}}</h3>
                    <div class="preview-details-grid">
                        {{#if selectedItem.displayStats.weaponSkill}}
                            <div><strong>Skill:</strong> {{selectedItem.displayStats.weaponSkill}}</div>
                        {{/if}}
                        {{#if selectedItem.displayStats.range}}
                            <div><strong>Range:</strong> {{selectedItem.displayStats.range}}</div>
                        {{/if}}
                        {{#if selectedItem.displayStats.grip}}
                            <div><strong>Grip:</strong> {{selectedItem.displayStats.grip}}</div>
                        {{/if}}
                        {{#if selectedItem.displayStats.damage1h}}
                            <div><strong>1H Damage:</strong> {{selectedItem.displayStats.damage1h}}</div>
                        {{/if}}
                        {{#if selectedItem.displayStats.damage2h}}
                            <div><strong>2H Damage:</strong> {{selectedItem.displayStats.damage2h}}</div>
                        {{/if}}
                        {{#if selectedItem.displayStats.damageType}}
                            <div class="damage-type-row">
                                <strong>Damage Type:</strong>
                                {{#if selectedItem.displayStats.damageTypeIcon}}
                                    <i class="{{selectedItem.displayStats.damageTypeIcon}}"></i>
                                {{/if}}
                                {{selectedItem.displayStats.damageType}}
                            </div>
                        {{/if}}
                        <div><strong>Slots:</strong> {{selectedItem.displayStats.slots}}</div>
                        <div><strong>Cost:</strong>
                            {{#if selectedItem.displayStats.cost.gold}}{{selectedItem.displayStats.cost.gold}}g {{/if}}
                            {{#if selectedItem.displayStats.cost.silver}}{{selectedItem.displayStats.cost.silver}}s {{/if}}
                            {{#if selectedItem.displayStats.cost.copper}}{{selectedItem.displayStats.cost.copper}}c{{/if}}
                            {{#unless (or selectedItem.displayStats.cost.gold selectedItem.displayStats.cost.silver selectedItem.displayStats.cost.copper)}}0s{{/unless}}
                        </div>
                    </div>
                    {{#if selectedItem.displayStats.propertiesWithHints}}
                        <div class="weapon-properties">
                            <h4>{{localize "VAGABOND.UI.Labels.Properties"}}</h4>
                            {{#each selectedItem.displayStats.propertiesWithHints}}
                                <div class="property-item" title="{{localize this.hint}}">
                                    <strong>{{localize this.label}}:</strong> <em>{{localize this.hint}}</em>
                                </div>
                            {{/each}}
                        </div>
                    {{/if}}
                {{/if}}

                {{!-- ARMOR --}}
                {{#if (eq selectedItem.displayStats.subType "armor")}}
                    <h3 class="preview-section-header">{{localize "VAGABOND.UI.Labels.ArmorDetails"}}</h3>
                    {{#if selectedItem.displayStats.armorTypeDescription}}
                        <div class="armor-type-description">
                            <em>{{selectedItem.displayStats.armorTypeDescription}}</em>
                        </div>
                    {{/if}}
                    <div class="preview-details-grid">
                        {{#if selectedItem.displayStats.armorRating}}
                            <div><strong>Armor Rating:</strong> {{selectedItem.displayStats.armorRating}}</div>
                        {{/if}}
                        {{#if selectedItem.displayStats.mightRequirement}}
                            <div><strong>Might Requirement:</strong> {{selectedItem.displayStats.mightRequirement}}</div>
                        {{/if}}
                        {{#if selectedItem.displayStats.armorType}}
                            <div><strong>Type:</strong> {{selectedItem.displayStats.armorType}}</div>
                        {{/if}}
                        <div><strong>Slots:</strong> {{selectedItem.displayStats.slots}}</div>
                        <div><strong>Cost:</strong>
                            {{#if selectedItem.displayStats.cost.gold}}{{selectedItem.displayStats.cost.gold}}g {{/if}}
                            {{#if selectedItem.displayStats.cost.silver}}{{selectedItem.displayStats.cost.silver}}s {{/if}}
                            {{#if selectedItem.displayStats.cost.copper}}{{selectedItem.displayStats.cost.copper}}c{{/if}}
                            {{#unless (or selectedItem.displayStats.cost.gold selectedItem.displayStats.cost.silver selectedItem.displayStats.cost.copper)}}0s{{/unless}}
                        </div>
                    </div>
                {{/if}}

                {{!-- ALCHEMICALS --}}
                {{#if (eq selectedItem.displayStats.subType "alchemical")}}
                    <h3 class="preview-section-header">{{localize "VAGABOND.UI.Labels.AlchemicalDetails"}}</h3>
                    <div class="preview-details-grid">
                        {{#if selectedItem.displayStats.alchemicalType}}
                            <div><strong>Type:</strong> {{selectedItem.displayStats.alchemicalType}}</div>
                        {{/if}}
                        {{#if selectedItem.displayStats.damage}}
                            <div><strong>Damage:</strong> {{selectedItem.displayStats.damage}}</div>
                        {{/if}}
                        {{#if selectedItem.displayStats.damageType}}
                            <div class="damage-type-row">
                                <strong>Damage Type:</strong>
                                {{#if selectedItem.displayStats.damageTypeIcon}}
                                    <i class="{{selectedItem.displayStats.damageTypeIcon}}"></i>
                                {{/if}}
                                {{selectedItem.displayStats.damageType}}
                            </div>
                        {{/if}}
                        <div><strong>Slots:</strong> {{selectedItem.displayStats.slots}}</div>
                        <div><strong>Cost:</strong>
                            {{#if selectedItem.displayStats.cost.gold}}{{selectedItem.displayStats.cost.gold}}g {{/if}}
                            {{#if selectedItem.displayStats.cost.silver}}{{selectedItem.displayStats.cost.silver}}s {{/if}}
                            {{#if selectedItem.displayStats.cost.copper}}{{selectedItem.displayStats.cost.copper}}c{{/if}}
                            {{#unless (or selectedItem.displayStats.cost.gold selectedItem.displayStats.cost.silver selectedItem.displayStats.cost.copper)}}0s{{/unless}}
                        </div>
                    </div>
                {{/if}}

                {{!-- RELICS --}}
                {{#if (eq selectedItem.displayStats.subType "relic")}}
                    <h3 class="preview-section-header">{{localize "VAGABOND.UI.Labels.RelicDetails"}}</h3>
                    {{#if selectedItem.displayStats.lore}}
                        <div class="relic-lore">
                            <strong>{{localize "VAGABOND.Item.Relic.FIELDS.lore.label"}}: </strong>
                            <span>{{{selectedItem.displayStats.enrichedLore}}}</span>
                        </div>
                    {{/if}}
                    <div class="preview-details-grid">
                        <div><strong>Slots:</strong> {{selectedItem.displayStats.slots}}</div>
                        <div><strong>Cost:</strong>
                            {{#if selectedItem.displayStats.cost.gold}}{{selectedItem.displayStats.cost.gold}}g {{/if}}
                            {{#if selectedItem.displayStats.cost.silver}}{{selectedItem.displayStats.cost.silver}}s {{/if}}
                            {{#if selectedItem.displayStats.cost.copper}}{{selectedItem.displayStats.cost.copper}}c{{/if}}
                            {{#unless (or selectedItem.displayStats.cost.gold selectedItem.displayStats.cost.silver selectedItem.displayStats.cost.copper)}}0s{{/unless}}
                        </div>
                    </div>
                {{/if}}

                {{!-- GEAR (generic) --}}
                {{#if (eq selectedItem.displayStats.subType "gear")}}
                    <h3 class="preview-section-header">{{localize "VAGABOND.UI.Labels.GearDetails"}}</h3>
                    <div class="preview-details-grid">
                        <div><strong>Slots:</strong> {{selectedItem.displayStats.slots}}</div>
                        <div><strong>Cost:</strong>
                            {{#if selectedItem.displayStats.cost.gold}}{{selectedItem.displayStats.cost.gold}}g {{/if}}
                            {{#if selectedItem.displayStats.cost.silver}}{{selectedItem.displayStats.cost.silver}}s {{/if}}
                            {{#if selectedItem.displayStats.cost.copper}}{{selectedItem.displayStats.cost.copper}}c{{/if}}
                            {{#unless (or selectedItem.displayStats.cost.gold selectedItem.displayStats.cost.silver selectedItem.displayStats.cost.copper)}}0s{{/unless}}
                        </div>
                    </div>
                {{/if}}
            </div>
        {{/if}}
    {{/if}}
</article>
