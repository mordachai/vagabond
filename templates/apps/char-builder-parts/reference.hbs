<aside class="reference-column custom-scroll {{#unless useTripleColumn}}hidden{{/unless}}">
    {{!-- COLUMN 3: ANCESTRY DATA --}}
    {{#if (eq step 'ancestry')}}
        {{#if selectedItem}}
            <div class="ancestry-summary-box">
                <h4 class="ref-header">{{localize "VAGABOND.UI.Labels.AncestryDetails"}}</h4>

                {{!-- Ancestry Info Grid --}}
                <div class="ancestry-details-grid">
                    <div class="detail-item">
                        <span class="label">Type:</span>
                        <span class="value">{{selectedItem.ancestryType}}</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">Size:</span>
                        <span class="value">{{capitalize selectedItem.size}}</span>
                    </div>
                </div>

                {{#if selectedItem.traits}}
                    <h4 class="ref-header">{{localize "VAGABOND.CharBuilder.Traits"}}</h4>
                    {{#each selectedItem.traits}}
                        <div class="ref-entry">
                            <strong>{{this.name}}:</strong> {{{this.description}}}
                        </div>
                    {{/each}}
                {{/if}}
            </div>
        {{/if}}
    {{/if}}

    {{!-- COLUMN 3: CLASS DATA --}}
    {{#if (eq step 'class')}}
        {{#if classPreviewData}}
            <div class="class-summary-box">
                <h4 class="ref-header">{{localize "VAGABOND.CharBuilder.ClassDetails"}}</h4>

                {{!-- 2-Column Grid for Class Info --}}
                <div class="class-details-grid">
                    <div class="detail-item">
                        <span class="label">Spellcaster:</span>
                        <span class="value">{{localize (concat "VAGABOND.Terms." classPreviewData.isSpellcaster)}}</span>
                    </div>
                    {{#if (eq classPreviewData.isSpellcaster "Yes")}}
                        <div class="detail-item">
                            <span class="label">Mana Skill:</span>
                            <span class="value">{{classPreviewData.manaSkillLabel}}</span>
                        </div>
                    {{/if}}
                </div>

                <h4 class="ref-header">{{localize "VAGABOND.CharBuilder.Levels"}}</h4>
                {{#each classPreviewData.levelGroups}}
                    <details class="level-accordion" {{#if this.isOpen}}open{{/if}}>
                        <summary class="level-header">
                            <i class="fas fa-chevron-right"></i>
                            <span>Level {{this.level}}</span>
                        </summary>
                        <div class="level-content">
                            {{#if (eq @root.classPreviewData.isSpellcaster "Yes")}}
                                <div class="level-traits">
                                    <div class="trait-badge">
                                        <strong>Mana:</strong> <span>{{this.maxMana}}</span>
                                    </div>
                                    {{#if this.spells}}
                                        <div class="trait-badge">
                                            <strong>Spells:</strong> <span>{{this.spells}}</span>
                                        </div>
                                    {{/if}}
                                </div>
                            {{/if}}
                            {{#each this.features}}
                                <div class="ref-entry">
                                    <strong>{{this.name}}:</strong> {{{this.enrichedDescription}}}
                                </div>
                            {{/each}}
                        </div>
                    </details>
                {{/each}}
            </div>
        {{/if}}
    {{/if}}

    {{!-- COLUMN 3: SPELLS STEP - Mana Stats, Ancestry Traits, and Class Features --}}
    {{#if (eq step 'spells')}}
        {{#if manaStats}}
            <div class="spells-summary-box">
                {{!-- Mana Stats Row --}}
                <div class="mana-stats-row">
                    <div class="mana-stat">
                        <span class="label"><i class="fas fa-star-christmas"></i> {{localize "VAGABOND.UI.Labels.Mana"}}:</span>
                        <span class="value">{{manaStats.manaMax}}</span>
                    </div>
                    <div class="mana-stat">
                        <span class="label">{{localize "VAGABOND.ResourceTypes.ManaPerCast"}}:</span>
                        <span class="value">{{manaStats.manaCast}}</span>
                    </div>
                </div>
            </div>
        {{/if}}

        {{!-- Ancestry Traits --}}
        {{#if ancestryData}}
            <div class="ancestry-summary-box mt-10">
                <h4 class="ref-header">{{localize "TYPES.Item.ancestry"}}: {{ancestryData.name}}</h4>

                {{#if ancestryData.traits.length}}
                    <div class="traits-list">
                        <strong>{{localize "VAGABOND.UI.Sections.Traits"}}:</strong>
                        {{#each ancestryData.traits}}
                            <div class="ref-entry">
                                <strong>{{this.name}}:</strong> {{this.description}}
                            </div>
                        {{/each}}
                    </div>
                {{/if}}
            </div>
        {{/if}}

        {{!-- Class Features (All Levels) --}}
        {{#if classPreviewData}}
            <div class="class-summary-box mt-10">
                <h4 class="ref-header">{{localize "VAGABOND.CharBuilder.Steps.Class"}}: {{classPreviewData.name}}</h4>

                {{#if classPreviewData.levels.length}}
                    {{#each classPreviewData.levels}}
                        <details class="level-accordion" {{#if (eq this.level 1)}}open{{/if}}>
                            <summary class="level-header">
                                <i class="fas fa-chevron-right"></i>
                                <span>{{localize "VAGABOND.UI.Sections.Level"}} {{this.level}}</span>
                            </summary>
                            <div class="level-content">
                                {{#if this.features.length}}
                                    {{#each this.features}}
                                        <div class="ref-entry">
                                            <strong>{{this.name}}:</strong> {{{this.enrichedDescription}}}
                                        </div>
                                    {{/each}}
                                {{else}}
                                    <p class="text-muted italic">No features at this level</p>
                                {{/if}}
                            </div>
                        </details>
                    {{/each}}
                {{else}}
                    <p class="text-muted italic">No class features defined</p>
                {{/if}}
            </div>
        {{/if}}
    {{/if}}

    {{!-- Origin Refs (Ancestry Traits/Class Features for perks step) --}}
    {{#if (eq step 'perks')}}
        {{#if originRefs.ancestry}}
            <h4 class="ref-header">{{localize "VAGABOND.UI.Sections.Traits"}} ({{originRefs.ancestry.name}})</h4>
            {{#each originRefs.ancestry.traits}}
                <div class="ref-entry"><strong>{{this.name}}: </strong> {{{this.description}}}</div>
            {{/each}}
        {{/if}}
        {{#if originRefs.class}}
            <h4 class="ref-header">{{localize "VAGABOND.UI.Sections.Features"}} ({{originRefs.class.name}})</h4>
            {{#each originRefs.class.features}}
                <div class="ref-entry"><strong>{{this.name}}: </strong>{{{this.enrichedDescription}}}</div>
            {{/each}}
        {{/if}}
    {{/if}}
</aside>
