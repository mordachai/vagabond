{{!-- Tray Zone (visible on perks/spells/gear steps) --}}
<section class="tray-zone {{#unless showTray}}hidden{{/unless}}">
    <div class="tray-grid">
        {{!-- Instruction column (left side) --}}
        <div class="tray-sidebar">
            {{!-- <h3>{{localize "VAGABOND.CharBuilder.TrayTitle"}}</h3> --}}
            <p><small>{{localize "VAGABOND.CharBuilder.TrayInstructions"}}</small></p>

            {{#if (eq step 'gear')}}
                {{#if inventorySlots}}
                    <div class="pack-summary">
                        <p><strong>Inventory Slots:</strong> {{inventorySlots.occupied}}/{{inventorySlots.max}} (Free: {{inventorySlots.free}})</p>
                    </div>
                {{/if}}
            {{/if}}

            {{#if (eq step 'perks')}}
                {{#if perkLimit}}
                    <div class="pack-summary perk-limit-display">
                        <p class="{{#unless (gte currentPerkCount perkLimit)}}incomplete{{/unless}}"><strong>Perks:</strong> {{currentPerkCount}}/{{perkLimit}}</p>
                        {{#if (gte currentPerkCount perkLimit)}}
                            <p class="text-warning"><small>Maximum reached</small></p>
                        {{/if}}
                    </div>
                {{/if}}
            {{/if}}

            {{#if (eq step 'spells')}}
                {{#if spellLimit}}
                    <div class="pack-summary spell-limit-display">
                        <p class="{{#unless (gte currentSpellCount spellLimit)}}incomplete{{/unless}}"><strong>Spells:</strong> {{currentSpellCount}}/{{spellLimit}}</p>
                        {{#if requiredSpellCount}}
                            <p class="text-info"><small>{{requiredSpellCount}} required</small></p>
                        {{/if}}
                        {{#if (gte currentSpellCount spellLimit)}}
                            <p class="text-warning"><small>Maximum reached</small></p>
                        {{/if}}
                    </div>
                {{/if}}
            {{/if}}

            <button type="button" class="btn-clear-tray" data-action="clearTray">
                <i class="fas fa-trash"></i> {{localize "VAGABOND.CharBuilder.Buttons.ClearTray"}}
            </button>
        </div>

        {{!-- Items grid (4 columns) --}}
        <div class="tray-items-grid">
            {{#if (eq step 'perks')}}
                {{#if trayData.isEmpty}}
                    <div class="tray-empty-message">
                        <i class="fas fa-arrow-left"></i>
                        <p>{{localize "VAGABOND.CharBuilder.TrayEmpty"}}</p>
                    </div>
                {{else}}
                    {{#each trayData.perks as |item|}}
                        <div class="tray-item-compact {{#if item.isClassPerk}}from-class{{/if}}" data-uuid="{{item.uuid}}">
                            <img src="{{item.img}}" alt="{{item.name}}" class="tray-img">
                            <div class="tray-item-text">
                                <span class="tray-name">{{item.name}}{{#if item.isClassPerk}} <i class="fas fa-star" title="From Class"></i>{{/if}}</span>
                                {{#if item.grantLabel}}
                                    <span class="tray-grant-label">{{item.grantLabel}}</span>
                                {{/if}}
                            </div>
                            {{#if item.canDelete}}
                                <button type="button" class="btn-remove" data-action="removeFromTray" data-uuid="{{item.uuid}}" title="Remove">
                                    <i class="fas fa-times"></i>
                                </button>
                            {{else}}
                                <i class="fas fa-lock class-perk-lock" title="Granted by class"></i>
                            {{/if}}
                        </div>
                    {{/each}}
                {{/if}}
            {{else if (eq step 'spells')}}
                {{#if requiredSpellCount}}
                    <div class="required-spells-notice">
                        <i class="fas fa-star"></i>
                        <strong>{{requiredSpellCount}}</strong> {{#if (eq requiredSpellCount 1)}}spell{{else}}spells{{/if}} granted by your ancestry/class (cannot be removed)
                    </div>
                {{/if}}

                {{!-- Always show selected spells, regardless of spell limit --}}
                {{#if trayData.spells.length}}
                    {{#each trayData.spells as |item|}}
                        <div class="tray-item-compact spell-slot filled {{#if item.isRequired}}required{{/if}}" data-uuid="{{item.uuid}}">
                            <img src="{{item.img}}" alt="{{item.name}}" class="tray-img">
                            <span class="tray-name">
                                {{item.name}}
                            </span>
                            {{#if item.isRequired}}
                                <i class="fas fa-lock required-lock" title="Required spell"></i>
                            {{else}}
                                <button type="button" class="btn-remove" data-action="removeFromTray" data-uuid="{{item.uuid}}" title="Remove">
                                    <i class="fas fa-times"></i>
                                </button>
                            {{/if}}
                        </div>
                    {{/each}}
                {{else}}
                    {{!-- No spells selected yet --}}
                    <div class="tray-empty-message">
                        <i class="fas fa-arrow-left"></i>
                        <p>{{localize "VAGABOND.CharBuilder.TrayEmpty"}}</p>
                    </div>
                {{/if}}

                {{!-- Show empty slots only if spell limit exists (for spellcaster classes) --}}
                {{#if (and spellLimit trayData.emptySlots.length)}}
                    {{#each trayData.emptySlots as |slot|}}
                        <div class="tray-item-compact spell-slot empty">
                            <div class="empty-slot-placeholder">
                                <i class="fas fa-plus-circle"></i>
                                <span class="empty-slot-text">Empty</span>
                            </div>
                        </div>
                    {{/each}}
                {{/if}}
            {{else if (eq step 'gear')}}
                {{#if trayData.isEmpty}}
                    <div class="tray-empty-message">
                        <i class="fas fa-arrow-left"></i>
                        <p>{{localize "VAGABOND.CharBuilder.TrayEmpty"}}</p>
                    </div>
                {{else}}
                    {{#each trayData.gear as |item|}}
                        <div class="tray-item-compact gear-item {{#if item.fromStartingPack}}from-pack{{/if}}" data-uuid="{{item.uuid}}">
                            <img src="{{item.img}}" alt="{{item.name}}" class="tray-img">
                            <div class="tray-info">
                                <span class="tray-name">{{item.name}}{{#if item.qty}} x{{item.qty}}{{/if}}</span>
                                <span class="tray-meta">{{item.slots}} slots â€¢ {{item.costDisplay}}</span>
                            </div>
                            {{#if item.canDelete}}
                                <button type="button" class="btn-remove" data-action="removeFromTray" data-uuid="{{item.uuid}}" title="Remove">
                                    <i class="fas fa-times"></i>
                                </button>
                            {{/if}}
                        </div>
                    {{/each}}
                {{/if}}
            {{/if}}
        </div>
    </div>
</section>
